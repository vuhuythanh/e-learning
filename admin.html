<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>YADEA Admin Pro - Secured Portal</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>

  <style>
    body { font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
    .sidebar-link.active { background: linear-gradient(90deg, #ea580c 0%, #f97316 100%); color: white; box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3); }
    ::-webkit-scrollbar { width: 4px; height: 4px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* CHAT ADMIN CSS */
    .chat-user-item:hover { background-color: #f3f4f6; cursor: pointer; }
    .chat-user-item.active { background-color: #fff7ed; border-left: 4px solid #f97316; }
    .chat-bubble-admin { max-width: 75%; padding: 10px; border-radius: 10px; font-size: 13px; margin-bottom: 5px; }
    .bubble-me { background: #f97316; color: white; align-self: flex-end; }
    .bubble-user { background: #e5e7eb; color: #374151; align-self: flex-start; }
    
    /* Mobile Overlay */
    #sidebarOverlay { transition: opacity 0.3s; }
    #sidebarOverlay.hidden { pointer-events: none; opacity: 0; }
    
    /* Responsive Table Wrapper */
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-700">

  <div id="adminAuthOverlay" class="fixed inset-0 z-[60] bg-[#111827] flex items-center justify-center px-4">
      <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center fade-in">
          <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-12 mx-auto mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-1">ADMIN PORTAL</h2>
          <p class="text-sm text-gray-500 mb-8">Khu v·ª±c qu·∫£n tr·ªã c·∫•p cao</p>
          <div class="space-y-4 text-left">
              <div><label class="block text-xs font-bold text-gray-600 mb-1">Email Admin</label><input id="admEmail" type="email" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:border-orange-500 outline-none transition" value="vuhuythanh271092@gmail.com"></div>
              <div><label class="block text-xs font-bold text-gray-600 mb-1">M·∫≠t kh·∫©u</label><input id="admPass" type="password" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:border-orange-500 outline-none transition"></div>
              <button id="admLoginBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95">ƒêƒÇNG NH·∫¨P</button>
              <p id="admError" class="text-center text-xs text-red-500 font-bold h-4"></p>
          </div>
          <div class="mt-6 text-xs text-gray-400">H·ªá th·ªëng ch·ªâ d√†nh cho nh√¢n s·ª± ƒë∆∞·ª£c ·ªßy quy·ªÅn.</div>
      </div>
  </div>

  <div id="appContainer" class="hidden flex-1 flex h-full w-full relative">
      
      <div class="md:hidden absolute top-0 left-0 w-full h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-30 shadow-sm">
          <div class="flex items-center gap-3">
              <button onclick="toggleSidebar()" class="text-gray-600 hover:text-orange-600 p-2"><i class="fa-solid fa-bars text-xl"></i></button>
              <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-6 w-auto">
          </div>
          <div class="font-bold text-xs text-orange-600 uppercase">Admin Mobile</div>
      </div>

      <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass"></div>

      <aside id="mainSidebar" class="fixed inset-y-0 left-0 w-64 bg-[#111827] text-gray-300 flex flex-col z-50 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 ease-in-out shadow-2xl md:shadow-none">
        <div class="h-16 flex items-center justify-between px-6 bg-[#0f172a]">
            <div class="flex items-center gap-3">
                <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-6 w-auto">
                <h1 class="font-bold text-white text-sm">ADMIN PORTAL</h1>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        <div class="px-6 py-4 border-b border-gray-800">
            <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-xs">AD</div><div class="overflow-hidden"><div class="text-xs font-bold text-white truncate" id="adminNameDisplay">Admin</div><div class="text-[10px] text-green-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-400"></span> Online</div></div></div>
        </div>
        <nav class="flex-1 px-3 py-6 space-y-1 overflow-y-auto">
          <button onclick="switchTab('dashboard')" id="tabDashboard" class="sidebar-link active w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-chart-pie w-5"></i> Dashboard KPI</button>
          <button onclick="switchTab('lessons')" id="tabLessons" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-layer-group w-5"></i> Kho b√†i h·ªçc</button>
          <button onclick="switchTab('users')" id="tabUsers" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-users w-5"></i> Qu·∫£n l√Ω User <span id="pendingCount" class="hidden ml-auto bg-red-500 text-white text-[10px] px-1.5 rounded-full">0</span></button>
          <button onclick="switchTab('progress')" id="tabProgress" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-bars-progress w-5"></i> Ti·∫øn ƒë·ªô ƒë√†o t·∫°o</button>
          <button onclick="switchTab('reports')" id="tabReports" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-trophy w-5"></i> B·∫£ng x·∫øp h·∫°ng</button>
          
          <button onclick="switchTab('gifts')" id="tabGifts" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-gift w-5"></i> Qu·∫£n l√Ω Qu√† t·∫∑ng</button>
          <button onclick="switchTab('settings')" id="tabSettings" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-gears w-5"></i> C·∫•u h√¨nh H·ªá th·ªëng</button>

          <div class="pt-4 mt-4 border-t border-gray-700"><p class="px-3 text-[10px] uppercase font-bold text-gray-500 mb-2">Enterprise Data</p><button onclick="switchTab('shops')" id="tabShops" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-store w-5"></i> D·ªØ li·ªáu ƒê·∫°i l√Ω</button></div>
          <div class="pt-4 mt-4 border-t border-gray-700"><button onclick="switchTab('chat')" id="tabChat" class="sidebar-link w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition"><i class="fa-solid fa-comments w-5"></i> H·ªó tr·ª£ / Chat <span id="chatUnreadCount" class="hidden bg-red-600 text-white text-[10px] px-1.5 rounded-full ml-auto">0</span></button></div>
        </nav>
        <div class="p-4 border-t border-gray-800"><button id="adminLogoutBtn" class="flex gap-2 text-sm text-gray-400 hover:text-white transition w-full items-center px-2 py-2"><i class="fa-solid fa-arrow-right-from-bracket"></i> ƒêƒÉng xu·∫•t</button></div>
      </aside>

      <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-gray-50 pt-14 md:pt-0">
        
        <div id="viewDashboard" class="flex-1 flex flex-col h-full overflow-y-auto p-4 md:p-6 scroll-smooth">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div><h2 class="text-xl md:text-2xl font-bold text-gray-800">Th·ªëng K√™ Hi·ªáu Su·∫•t</h2><p class="text-sm text-gray-500">T·ªïng h·ª£p KPI theo Shop, V√πng v√† Nh√¢n s·ª±</p></div>
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <select id="dashFilterLesson" onchange="loadDashboard()" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm shadow-sm outline-none flex-1 md:w-48"><option value="all">-- T·∫•t c·∫£ b√†i h·ªçc --</option></select>
                    <select id="dashFilterDirector" onchange="loadDashboard()" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm shadow-sm outline-none flex-1 md:w-40"><option value="all">-- T·∫•t c·∫£ GƒêKV --</option></select>
                    <button onclick="loadDashboard(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-md"><i class="fa-solid fa-rotate"></i></button>
                    <button onclick="exportKPIDashboard()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-md"><i class="fa-solid fa-file-excel"></i> Xu·∫•t</button>
                </div>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group hover:shadow-md transition"><div class="z-10"><p class="text-xs font-bold text-gray-400 uppercase mb-1">T·ª∑ l·ªá Ho√†n Th√†nh</p><h3 id="kpiRate" class="text-3xl font-bold text-gray-800">0%</h3></div><div class="z-10"><span class="text-xs font-medium text-green-500 bg-green-50 px-2 py-1 rounded-full">To√†n qu·ªëc</span></div><i class="fa-solid fa-chart-pie absolute -bottom-4 -right-4 text-8xl text-gray-50 opacity-50 group-hover:opacity-100 transition-all"></i></div>
                <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group hover:shadow-md transition"><div class="z-10"><p class="text-xs font-bold text-gray-400 uppercase mb-1">ƒêi·ªÉm Trung B√¨nh</p><h3 id="kpiAvgScore" class="text-3xl font-bold text-blue-600">0.0</h3></div><div class="z-10"><span class="text-xs text-gray-400">Thang ƒëi·ªÉm 100</span></div><i class="fa-solid fa-graduation-cap absolute -bottom-4 -right-4 text-8xl text-gray-50 opacity-50 group-hover:opacity-100 transition-all"></i></div>
                <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group hover:shadow-md transition"><div class="z-10"><p class="text-xs font-bold text-gray-400 uppercase mb-1">Shop ƒê·∫°t Chu·∫©n</p><h3 id="kpiShopPass" class="text-3xl font-bold text-green-600">0</h3></div><div class="z-10"><span id="kpiShopTotal" class="text-xs text-gray-500">tr√™n t·ªïng s·ªë 0 shop</span></div><i class="fa-solid fa-store absolute -bottom-4 -right-4 text-8xl text-gray-50 opacity-50 group-hover:opacity-100 transition-all"></i></div>
                <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group hover:shadow-md transition"><div class="z-10"><p class="text-xs font-bold text-gray-400 uppercase mb-1">Nh√¢n S·ª± Tham Gia</p><h3 id="kpiUserActive" class="text-3xl font-bold text-purple-600">0</h3></div><div class="z-10"><span class="text-xs text-gray-400">ƒê√£ l√†m b√†i thi</span></div><i class="fa-solid fa-users absolute -bottom-4 -right-4 text-8xl text-gray-50 opacity-50 group-hover:opacity-100 transition-all"></i></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm md:text-base"><i class="fa-solid fa-medal text-yellow-500"></i> Top 10 C·ª≠a H√†ng (ƒêi·ªÉm TB)</h3><div id="chartTopShops" class="w-full h-64 md:h-80"></div></div>
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm md:text-base"><i class="fa-solid fa-user-graduate text-blue-500"></i> Top 10 Nh√¢n Vi√™n (ƒêi·ªÉm Cao)</h3><div id="chartTopStaff" class="w-full h-64 md:h-80"></div></div>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 mb-8"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm md:text-base"><i class="fa-solid fa-map-location-dot text-red-500"></i> B·∫£n ƒê·ªì Nhi·ªát: T·ª∑ L·ªá Ho√†n Th√†nh</h3><div id="chartRegionMap" class="w-full h-80 md:h-96"></div></div>
        </div>

        <div id="viewLessons" class="hidden flex-1 flex flex-col h-full bg-white">
            <header class="h-16 bg-white border-b flex justify-between items-center px-4 md:px-6 flex-shrink-0"><h2 class="text-lg md:text-xl font-bold">Qu·∫£n l√Ω b√†i h·ªçc</h2><button onclick="resetForm()" class="bg-gray-900 text-white text-xs md:text-sm px-3 py-2 rounded-lg font-bold"><i class="fa-solid fa-plus"></i> T·∫°o m·ªõi</button></header>
            <div class="flex-1 overflow-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 bg-white rounded-2xl shadow-sm border p-2 flex flex-col h-[300px] lg:h-[calc(100vh-140px)]">
                    <div class="p-2 border-b mb-2">
                        <input id="searchLessonInput" onkeyup="filterAdminLessons()" placeholder="üîç T√¨m nhanh b√†i h·ªçc..." class="w-full border bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none focus:border-orange-500 transition">
                    </div>
                    <div id="lessonList" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
                </div>
                
                <div class="lg:col-span-8 space-y-6 pb-20 lg:pb-0">
                    <div class="bg-white rounded-2xl shadow-sm border p-4 md:p-6">
                        <h3 id="formTitle" class="font-bold mb-4">Th√¥ng tin b√†i h·ªçc</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2"><label class="text-xs font-bold">Ti√™u ƒë·ªÅ (*)</label><input id="inpTitle" class="w-full border rounded p-2 text-sm focus:border-orange-500 outline-none"></div>
                            <div class="col-span-2 bg-blue-50 p-3 rounded border border-blue-100">
                                <label class="text-xs font-bold text-blue-800 mb-2 block"><i class="fa-solid fa-user-lock"></i> ƒê·ªëi t∆∞·ª£ng xem:</label>
                                <div class="flex gap-4 flex-wrap"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="roleLearner" checked class="accent-blue-600"> <span class="text-sm">Nh√¢n vi√™n</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="roleSale" class="accent-blue-600"> <span class="text-sm font-bold text-orange-600">Sale Team</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="roleDirector" class="accent-blue-600"> <span class="text-sm font-bold text-purple-600">GƒêKV</span></label></div>
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label class="text-xs font-bold">Danh m·ª•c</label>
                                <select id="inpCategory" onchange="toggleSubInput()" class="w-full border rounded p-2 text-sm">
                                    <option value="video">H·ªçc qua Video</option>
                                    <option value="product">S·∫£n ph·∫©m</option>
                                    <option value="skill">K·ªπ nƒÉng</option>
                                    <option value="culture">VƒÉn ho√°</option>
                                </select>
                            </div>
                            <div id="divSubTag" class="hidden fade-in col-span-2 md:col-span-1">
                                <label class="text-xs font-bold text-orange-600">Ph√¢n lo·∫°i (NƒÉm/D√≤ng xe)</label>
                                <select id="inpSubTag" class="w-full border border-orange-200 bg-orange-50 rounded p-2 text-sm font-bold text-gray-700 outline-none focus:border-orange-500">
                                    <option value="">-- Kh√¥ng ch·ªçn --</option>
                                    <option value="2025">S·∫£n ph·∫©m 2025</option>
                                    <option value="2026">S·∫£n ph·∫©m 2026</option>
                                    <option value="xe-dien">Xe m√°y ƒëi·ªán</option>
                                    <option value="xe-dap-dien">Xe ƒë·∫°p ƒëi·ªán</option>
                                </select>
                            </div>
                            <div class="col-span-2 md:col-span-1"><label class="text-xs font-bold">Th·ªùi l∆∞·ª£ng (ph√∫t)</label><input id="inpDuration" class="w-full border rounded p-2 text-sm" placeholder="VD: 15"></div>
                            <div class="col-span-2 md:col-span-1"><label class="text-xs font-bold text-green-600">Y√™u c·∫ßu t·ªëi thi·ªÉu (ph√∫t)</label><input id="inpMinTime" type="number" value="5" class="w-full border rounded p-2 text-sm focus:border-green-500 font-bold text-green-700" placeholder="M·∫∑c ƒë·ªãnh: 5"></div>
                            <div class="col-span-2"><label class="text-xs font-bold">Link (Youtube/PDF) (*)</label><input id="inpContentUrl" class="w-full border rounded p-2 text-sm"></div>
                            <div class="col-span-2"><label class="text-xs font-bold">Link ·∫¢nh</label><input id="inpImage" class="w-full border rounded p-2 text-sm"></div>
                            <div class="col-span-2"><label class="text-xs font-bold">M√¥ t·∫£</label><textarea id="inpDesc" rows="3" class="w-full border rounded p-2 text-sm"></textarea></div>
                        </div>
                        <div class="mt-4 flex justify-between"><button id="btnDeleteLesson" class="hidden text-red-500 text-xs font-bold">X√≥a</button><button id="btnSaveLesson" class="bg-orange-500 text-white px-6 py-2 rounded-lg text-sm font-bold shadow hover:bg-orange-600">L∆∞u</button></div>
                    </div>
                    <div id="quizSection" class="hidden bg-white rounded-2xl shadow-sm border p-4 md:p-6">
                        <h3 class="font-bold mb-4 flex justify-between items-center"><span>C√¢u h·ªèi tr·∫Øc nghi·ªám</span><button id="btnCancelEditQ" class="hidden text-xs text-gray-500 hover:text-gray-800 underline" onclick="cancelEditQ()">H·ªßy s·ª≠a</button></h3>
                        <div class="bg-gray-50 p-4 rounded border border-dashed mb-4 transition-colors" id="quizInputBox">
                            <input id="qText" placeholder="N·ªôi dung c√¢u h·ªèi..." class="w-full border p-2 rounded mb-2 text-sm font-medium focus:border-orange-500 outline-none">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2"><input id="qOp0" placeholder="ƒê√°p √°n A" class="border p-2 text-sm rounded"><input id="qOp1" placeholder="ƒê√°p √°n B" class="border p-2 text-sm rounded"><input id="qOp2" placeholder="ƒê√°p √°n C" class="border p-2 text-sm rounded"><input id="qOp3" placeholder="ƒê√°p √°n D" class="border p-2 text-sm rounded"></div>
                            <div class="flex flex-col md:flex-row justify-between items-center gap-3"><div class="flex items-center gap-2"><span class="text-xs font-bold">ƒê√∫ng:</span><select id="qCorrect" class="border p-1 text-sm rounded font-bold text-orange-600"><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select></div><button id="btnAddQuestion" class="bg-gray-800 text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-black transition w-full md:w-auto">Th√™m c√¢u h·ªèi</button></div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-dashed flex items-center justify-between">
                            <div class="text-xs text-gray-500 font-bold">Ho·∫∑c Import t·ª´ Excel:</div>
                            <div class="flex items-center gap-2">
                                <input type="file" id="inpQuizExcel" accept=".xlsx, .xls" class="hidden" onchange="importQuizExcel(this)">
                                <button onclick="document.getElementById('inpQuizExcel').click()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm"><i class="fa-solid fa-file-excel"></i> Ch·ªçn File Excel</button>
                                <a href="#" onclick="downloadQuizTemplate()" class="text-xs text-blue-500 hover:underline">T·∫£i file m·∫´u</a>
                            </div>
                        </div>

                        <div id="questionList" class="space-y-2 mt-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewUsers" class="hidden flex-1 flex flex-col h-full bg-gray-50">
            <header class="h-auto md:h-16 bg-white border-b flex flex-col md:flex-row justify-between items-start md:items-center px-4 md:px-6 py-3 gap-3">
                <h2 class="text-lg md:text-xl font-bold">Qu·∫£n l√Ω User</h2>
                <div class="flex flex-wrap gap-2 items-center w-full md:w-auto">
                    <select id="filterUserLesson" onchange="renderUserTable()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none bg-white font-medium text-blue-600 flex-1 md:flex-none">
                        <option value="all">-- Ki·ªÉm tra ti·∫øn ƒë·ªô --</option>
                    </select>
                    <input id="searchUser" onkeyup="renderUserTable()" placeholder="T√¨m t√™n/DVN..." class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none bg-white font-medium text-gray-600 w-full md:w-40">
                    <select id="filterUserStatus" onchange="renderUserTable()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none bg-white font-medium text-gray-600 flex-1 md:flex-none"><option value="all">-- Tr·∫°ng th√°i --</option><option value="pending">Ch·ªù duy·ªát</option><option value="active">Ho·∫°t ƒë·ªông</option></select>
                    <button onclick="loadUsers(true)" class="text-blue-600 hover:text-blue-800 text-sm font-bold ml-1"><i class="fa-solid fa-cloud-arrow-down"></i></button>
                </div>
            </header>
            <div class="p-4 md:p-6 max-w-7xl mx-auto w-full">
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden flex-1 flex flex-col">
                    <div class="table-responsive">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                                <tr>
                                    <th class="p-4">T√™n</th>
                                    <th class="p-4">DVN</th>
                                    <th class="p-4">Email</th>
                                    <th class="p-4" id="colDynamicTitle">ƒêi·ªÉm & Sao</th>
                                    <th class="p-4">Vai tr√≤</th>
                                    <th class="p-4">Tr·∫°ng th√°i</th>
                                    <th class="p-4 text-right">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody" class="text-sm divide-y text-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewProgress" class="hidden flex-1 flex flex-col h-full bg-gray-50">
            <header class="h-auto md:h-16 bg-white border-b flex flex-col md:flex-row justify-between items-start md:items-center px-4 md:px-6 py-3 gap-3">
                <h2 class="text-lg md:text-xl font-bold">Ti·∫øn ƒë·ªô ƒë√†o t·∫°o</h2>
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <select id="progressFilterLesson" onchange="loadProgress()" class="bg-white border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none font-bold text-blue-600 flex-1 md:w-64 shadow-sm">
                        <option value="all">-- Ch·ªçn b√†i h·ªçc --</option>
                    </select>
                    <select id="progressFilterStatus" onchange="loadProgress()" class="bg-white border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none font-medium text-gray-600 flex-1 md:w-auto">
                        <option value="all">T·∫•t c·∫£</option>
                        <option value="done">ƒê√£ h·ªçc</option>
                        <option value="not">Ch∆∞a h·ªçc</option>
                    </select>
                    <button onclick="exportProgressExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-sm"><i class="fa-solid fa-file-excel"></i> Xu·∫•t</button>
                </div>
            </header>
            <div class="p-4 md:p-6 max-w-7xl mx-auto w-full flex flex-col h-full">
                <div class="flex flex-wrap gap-2 mb-4 text-xs font-bold text-gray-500 uppercase tracking-wide">
                    <div class="bg-white px-3 py-2 rounded-lg border shadow-sm flex-1 md:flex-none text-center">T·ªïng: <span class="text-gray-900 text-sm ml-1" id="progTotal">0</span></div>
                    <div class="bg-white px-3 py-2 rounded-lg border shadow-sm flex-1 md:flex-none text-center">ƒê√£ h·ªçc: <span class="text-green-600 text-sm ml-1" id="progDone">0</span></div>
                    <div class="bg-white px-3 py-2 rounded-lg border shadow-sm flex-1 md:flex-none text-center">Ch∆∞a h·ªçc: <span class="text-red-500 text-sm ml-1" id="progNot">0</span></div>
                    <div class="bg-white px-3 py-2 rounded-lg border shadow-sm flex-1 md:flex-none text-center">T·ª∑ l·ªá: <span class="text-blue-600 text-sm ml-1" id="progRate">0%</span></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden flex-1 flex flex-col">
                    <div class="table-responsive">
                        <table class="w-full text-left whitespace-nowrap" id="progressTable">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500 sticky top-0">
                                <tr>
                                    <th class="p-4 w-12">#</th>
                                    <th class="p-4">H·ªç t√™n nh√¢n vi√™n</th>
                                    <th class="p-4">M√£ DVN / User</th>
                                    <th class="p-4">ƒê∆°n v·ªã / Shop</th>
                                    <th class="p-4 text-center">Tr·∫°ng th√°i h·ªçc</th>
                                </tr>
                            </thead>
                            <tbody id="progressTableBody" class="text-sm divide-y text-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewReports" class="hidden flex-1 flex flex-col h-full bg-gray-50">
            <header class="h-auto md:h-16 bg-white border-b flex flex-col md:flex-row justify-between items-start md:items-center px-4 md:px-6 py-3 gap-3"><h2 class="text-lg md:text-xl font-bold">B·∫£ng x·∫øp h·∫°ng</h2><div class="flex gap-3 w-full md:w-auto"><select id="reportFilterLesson" onchange="loadReports()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none bg-white flex-1 md:w-auto"><option value="all">-- T·∫•t c·∫£ b√†i h·ªçc --</option></select><button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-sm"><i class="fa-solid fa-file-excel"></i> Xu·∫•t</button><button onclick="loadReports(true)" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100">T·∫£i t·∫•t</button></div></header>
            <div class="p-4 md:p-6 max-w-7xl mx-auto w-full h-full flex flex-col"><div class="grid grid-cols-3 gap-2 md:gap-4 mb-4"><div class="bg-white p-3 rounded-xl border shadow-sm flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-500 uppercase">T·ªïng l∆∞·ª£t</span><span id="statTotal" class="text-lg md:text-xl font-bold text-gray-800">0</span></div><div class="bg-white p-3 rounded-xl border shadow-sm flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-500 uppercase">ƒê·∫≠u (100ƒë)</span><span id="statPass" class="text-lg md:text-xl font-bold text-green-600">0</span></div><div class="bg-white p-3 rounded-xl border shadow-sm flex flex-col items-center"><span class="text-[10px] md:text-xs text-gray-500 uppercase">R·ªõt (<100)</span><span id="statFail" class="text-lg md:text-xl font-bold text-red-600">0</span></div></div><div class="bg-white rounded-2xl shadow-sm border flex-1 overflow-hidden flex flex-col"><div class="table-responsive"><table class="w-full text-left whitespace-nowrap" id="reportTable"><thead class="bg-gray-50 text-xs uppercase text-gray-500 sticky top-0"><tr><th class="p-4 w-16">H·∫°ng</th><th class="p-4">Nh√¢n vi√™n</th><th class="p-4">B√†i h·ªçc</th><th class="p-4 text-center">ƒêi·ªÉm (100)</th><th class="p-4 text-center">Tr·∫°ng th√°i</th><th class="p-4">Th·ªùi gian</th><th class="p-4">Ng√†y thi</th><th class="p-4 text-right">X√≥a</th></tr></thead><tbody id="reportTableBody" class="text-sm divide-y"></tbody></table></div></div></div>
        </div>
        
        <div id="viewGifts" class="hidden flex-1 flex flex-col h-full bg-gray-50">
            <header class="h-16 bg-white border-b flex justify-between items-center px-6 py-3">
                <h2 class="text-xl font-bold">L·ªãch s·ª≠ Tr√∫ng th∆∞·ªüng</h2>
                <div class="flex gap-2">
                    <select id="filterGiftStatus" onchange="renderGiftTable()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm outline-none bg-white font-medium text-gray-600">
                        <option value="all">-- T·∫•t c·∫£ --</option>
                        <option value="pending" class="text-yellow-600 font-bold">Ch·ªù trao</option>
                        <option value="sent" class="text-green-600 font-bold">ƒê√£ trao</option>
                    </select>
                    <button onclick="exportGiftHistory()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-sm"><i class="fa-solid fa-file-excel"></i> Xu·∫•t Excel</button>
                    <button onclick="loadGifts()" class="text-gray-500 hover:text-orange-500 px-2"><i class="fa-solid fa-rotate"></i></button>
                </div>
            </header>
            <div class="p-6 max-w-7xl mx-auto w-full flex flex-col h-full">
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden flex-1 flex flex-col">
                    <div class="table-responsive">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500 sticky top-0">
                                <tr>
                                    <th class="p-4">Th·ªùi gian</th>
                                    <th class="p-4">Nh√¢n vi√™n</th>
                                    <th class="p-4">M√£ DVN</th>
                                    <th class="p-4">Ph·∫ßn qu√†</th>
                                    <th class="p-4">Th√¥ng tin nh·∫≠n qu√†</th>
                                    <th class="p-4 text-center">Tr·∫°ng th√°i</th>
                                    <th class="p-4 text-right">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="giftTableBody" class="text-sm divide-y text-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewSettings" class="hidden flex-1 flex flex-col h-full bg-gray-50">
            <header class="h-16 bg-white border-b flex items-center px-6 py-3">
                <h2 class="text-xl font-bold">C·∫•u h√¨nh H·ªá th·ªëng</h2>
            </header>
            <div class="p-6 max-w-2xl mx-auto w-full">
                <div class="bg-white rounded-2xl shadow-sm border p-6">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Th√¥ng b√°o to√†n h·ªá th·ªëng (Marquee)</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-600 mb-1">N·ªôi dung th√¥ng b√°o:</label>
                        <input id="sysNotifText" class="w-full border rounded-lg px-3 py-2 text-sm outline-none focus:border-orange-500" placeholder="V√≠ d·ª•: H·ªá th·ªëng b·∫£o tr√¨ l√∫c 12h...">
                        <p class="text-xs text-gray-400 mt-1">N·ªôi dung n√†y s·∫Ω ch·∫°y ch·ªØ tr√™n m√†n h√¨nh Home c·ªßa h·ªçc vi√™n.</p>
                    </div>
                    <div class="mb-6 flex items-center gap-3">
                        <label class="text-sm font-bold text-gray-600">Tr·∫°ng th√°i:</label>
                        <select id="sysNotifStatus" class="border rounded px-2 py-1 text-sm"><option value="on">B·∫≠t</option><option value="off">T·∫Øt</option></select>
                    </div>
                    <button onclick="saveSystemSettings()" class="bg-orange-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-700 transition">L∆∞u C·∫•u H√¨nh</button>
                </div>
            </div>
        </div>

        <div id="viewShops" class="hidden flex-1 flex flex-col h-full bg-gray-50">
            <header class="h-auto md:h-16 bg-white border-b flex flex-col md:flex-row justify-between items-start md:items-center px-4 md:px-6 py-3 gap-3">
                <h2 class="text-lg md:text-xl font-bold">D·ªØ li·ªáu ƒê·∫°i l√Ω</h2>
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <input type="file" id="inpImportShop" class="hidden" accept=".xlsx, .xls" onchange="handleImportShop(this)">
                    <button onclick="exportShopData()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-sm"><i class="fa-solid fa-file-excel"></i> Xu·∫•t</button>
                    <button onclick="document.getElementById('inpImportShop').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-sm"><i class="fa-solid fa-cloud-arrow-up"></i> Import</button>
                    <button onclick="loadShops()" class="text-gray-500 hover:text-orange-500 px-2"><i class="fa-solid fa-rotate"></i></button>
                </div>
            </header>
            <div class="p-4 md:p-6 max-[1800px] mx-auto w-full h-full flex flex-col">
                <div class="flex flex-col md:flex-row gap-3 mb-4">
                    <select id="filterShopLesson" onchange="loadShops()" class="bg-white border rounded px-3 py-1.5 text-sm outline-none flex-1 md:w-64 font-bold text-blue-600 shadow-sm"><option value="all">-- Check ti·∫øn ƒë·ªô b√†i --</option></select>
                    <select id="filterShopStatus" onchange="loadShops()" class="bg-white border rounded px-3 py-1.5 text-sm outline-none flex-1 md:w-40 font-bold text-gray-600"><option value="all">-- T·∫•t c·∫£ --</option><option value="done" class="text-green-600">ƒê√£ h·ªçc</option><option value="not_yet" class="text-red-600">Ch∆∞a h·ªçc</option></select>
                    <input id="searchShop" onkeyup="loadShops()" placeholder="T√¨m DVN, T√™n shop..." class="bg-white border rounded px-3 py-1.5 text-sm outline-none flex-1 md:w-80">
                </div>
                <div class="mb-2 text-xs text-gray-500 flex flex-wrap gap-4 uppercase font-bold tracking-wide">
                     <span>T·ªïng: <b id="shopStatTotal" class="text-gray-800">0</b></span>
                     <span>ƒê√£ h·ªçc: <b id="shopStatDone" class="text-green-600">-</b></span>
                     <span>Ch∆∞a h·ªçc: <b id="shopStatNot" class="text-red-600">-</b></span>
                     <span>T·ª∑ l·ªá: <b id="shopStatRate" class="text-blue-600">-</b></span>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border flex-1 overflow-hidden flex flex-col">
                    <div class="table-responsive">
                        <table class="w-full text-left whitespace-nowrap min-w-[1000px]">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500 sticky top-0 z-10"><tr><th class="p-4 w-24">M√£ CH</th><th class="p-4 w-64">T√™n ƒê·∫°i l√Ω</th><th class="p-4">Khu v·ª±c / GƒêKV</th><th class="p-4">Sale Rep</th><th class="p-4">ƒê·ªãa ch·ªâ</th><th class="p-4 text-center w-32">Tr·∫°ng th√°i</th><th class="p-4 text-right w-16">X√≥a</th></tr></thead>
                            <tbody id="shopTableBody" class="text-sm divide-y text-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewChat" class="hidden flex-1 flex-col h-full bg-white relative">
            <div class="flex h-full relative overflow-hidden">
                
                <div id="chatListCol" class="w-full md:w-80 border-r border-gray-200 bg-gray-50 flex flex-col h-full z-10 absolute md:relative bg-white transition-transform duration-300">
                    
                    <div class="h-14 px-4 border-b flex items-center justify-between bg-white shadow-sm z-10 shrink-0">
                        <div class="flex items-center gap-3">
                            <button onclick="switchTab('dashboard')" class="md:hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 hover:text-orange-600 hover:bg-orange-100 active:scale-95 transition" title="V·ªÅ trang ch·ªß">
                                <i class="fa-solid fa-house"></i>
                            </button>
                            
                            <span class="font-bold text-sm text-gray-800 uppercase flex items-center">
                                <i class="fa-solid fa-list-ul mr-2 text-orange-600"></i> Danh s√°ch h·ªó tr·ª£
                            </span>
                        </div>
                        <span id="chatUnreadCount" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden">0</span>
                    </div>

                    <div class="p-2 border-b bg-white">
                        <input onkeyup="filterChatList(this)" placeholder="üîç T√¨m t√™n h·ªçc vi√™n..." class="w-full bg-gray-100 border-none rounded-lg px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-orange-300 transition">
                    </div>

                    <div id="chatUserList" class="flex-1 overflow-y-auto pb-20 md:pb-0"></div>
                </div>

                <div id="chatAreaCol" class="w-full flex-1 flex flex-col h-full bg-white absolute md:relative translate-x-full md:translate-x-0 transition-transform duration-300 z-20">
                    
                    <div class="h-14 border-b flex items-center px-4 bg-white shadow-sm flex-shrink-0 justify-between z-10 z-50"> <div class="flex items-center gap-3 overflow-hidden">
                            <button onclick="closeChatMobile()" class="md:hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 hover:bg-orange-100 hover:text-orange-600 transition">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                            
                            <div class="flex flex-col min-w-0">
                                <div class="font-bold text-sm md:text-base truncate flex items-center gap-2" id="chatHeaderName">
                                    Ch·ªçn h·ªôi tho·∫°i
                                </div>
                                <div class="text-[10px] text-gray-400 font-mono truncate" id="chatHeaderDvn">...</div>
                            </div>
                        </div>
                    </div>

                    <div id="adminChatMessages" class="flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-3 scroll-smooth">
                        <div class="flex flex-col items-center justify-center h-full text-gray-300">
                            <i class="fa-regular fa-comments text-4xl mb-2"></i>
                            <p class="text-xs">Ch·ªçn m·ªôt h·ªçc vi√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                        </div>
                    </div>

                    <div id="adminChatInputBar" class="p-3 bg-white border-t flex gap-2 items-end flex-shrink-0 relative hidden">
                        <button onclick="document.getElementById('emojiPickerAdmin').classList.toggle('hidden')" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-orange-500 rounded-full hover:bg-gray-50 transition flex-shrink-0">
                            <i class="fa-regular fa-face-smile text-xl"></i>
                        </button>
                        
                        <div id="emojiPickerAdmin" class="hidden absolute bottom-16 left-2 bg-white border border-gray-200 shadow-2xl rounded-xl p-2 w-64 grid grid-cols-6 gap-1 z-50 animate-fade-in"></div>

                        <textarea id="adminChatInput" rows="1" class="flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-200 resize-none overflow-hidden" placeholder="Nh·∫≠p tin nh·∫Øn..." style="min-height: 42px; max-height: 100px;" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                        
                        <button onclick="sendAdminMsg()" class="w-10 h-10 flex items-center justify-center bg-orange-600 text-white rounded-full font-bold hover:bg-orange-700 shadow-lg shadow-orange-200 active:scale-95 transition flex-shrink-0 mb-0.5">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

      </main>
  </div>
  
  <div id="editPointModal" class="hidden fixed inset-0 bg-gray-900/50 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-fade-in">
          <h3 class="font-bold text-lg text-gray-800 mb-1">ƒêi·ªÅu ch·ªânh t√†i kho·∫£n</h3>
          <p id="editPointName" class="text-sm text-gray-500 mb-4">User: ...</p>
          <div class="space-y-3">
              <div>
                  <label class="text-xs font-bold text-gray-600">T·ªïng ƒëi·ªÉm t√≠ch l≈©y</label>
                  <input id="editInpPoints" type="number" class="w-full border rounded px-3 py-2 text-sm outline-none font-bold text-orange-600">
              </div>
              <div>
                  <label class="text-xs font-bold text-gray-600">L∆∞·ª£t quay kh·∫£ d·ª•ng</label>
                  <input id="editInpSpins" type="number" class="w-full border rounded px-3 py-2 text-sm outline-none font-bold text-blue-600">
              </div>
          </div>
          <div class="flex justify-end gap-2 mt-6">
              <button onclick="document.getElementById('editPointModal').classList.add('hidden')" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 text-xs font-bold hover:bg-gray-200">H·ªßy</button>
              <button onclick="saveUserPoints()" class="px-4 py-2 rounded-lg bg-orange-600 text-white text-xs font-bold hover:bg-orange-700 shadow-lg">L∆∞u thay ƒë·ªïi</button>
          </div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDocs, getDoc, query, where, serverTimestamp, orderBy, setDoc, limit, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp({ apiKey: "AIzaSyCJj_0-dVddgNBwPsm662guADskM5N9Q6I", authDomain: "e-learning-8d182.firebaseapp.com", projectId: "e-learning-8d182", storageBucket: "e-learning-8d182.firebasestorage.app", messagingSenderId: "1008025386680", appId: "1:1008025386680:web:5c91aa14e056e4578b7e4d", measurementId: "G-L6P2B51170" });
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentReportData = [], allShopsCache = [], dashboardData = {}, userCache = [];
    let currentChatUid = null;
    let shopNameMap = {}; 
    let cachedAdminLessons = [];
    let giftHistoryCache = [];
    
    // --- MOBILE SIDEBAR LOGIC ---
    window.toggleSidebar = () => {
        const sidebar = document.getElementById('mainSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const isClosed = sidebar.classList.contains('-translate-x-full');
        
        if (isClosed) {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    };

    // UTILS
    const normalize = (str) => str ? String(str).trim().toUpperCase() : '';

    window.resetPwd = async (email) => {
        if (!email) return alert("User n√†y kh√¥ng c√≥ email!");
        if (confirm(`G·ª≠i email y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u t·ªõi: ${email}?`)) {
            try { await sendPasswordResetEmail(auth, email); alert("ƒê√£ g·ª≠i email th√†nh c√¥ng!"); } catch (e) { alert("L·ªói: " + e.message); }
        }
    }

    // --- MAIN FUNCTION TO EXPORT SHOP DATA WITH PROGRESS ---
    window.exportShopData = async function() {
        const lessonId = document.getElementById('filterShopLesson').value;
        const statusFilter = document.getElementById('filterShopStatus').value;
        const search = document.getElementById('searchShop').value.toLowerCase();
        
        if(allShopsCache.length === 0) await fetchShopData();
        if(userCache.length === 0) await loadUsers(true);

        let finishedDvns = new Set();
        let lessonTitle = "ToanBo";

        if(lessonId !== 'all') {
            const lessonOpt = document.getElementById('filterShopLesson').options[document.getElementById('filterShopLesson').selectedIndex];
            if(lessonOpt) lessonTitle = lessonOpt.text;
            
            userCache.forEach(u => {
                if(u.completedActivities && u.completedActivities[`study_${lessonId}`] && u.dvnCode) {
                    finishedDvns.add(normalize(u.dvnCode));
                }
            });
        }

        const exportList = allShopsCache.filter(s => {
            const txt = ((s.dvn||'')+' '+(s.name||'')+' '+(s.saleRep||'')+' '+(s.director||'')+' '+(s.province||'')).toLowerCase();
            if (search && !txt.includes(search)) return false;
            
            if (lessonId !== 'all' && statusFilter !== 'all') {
                const isDone = finishedDvns.has(normalize(s.dvn));
                if (statusFilter === 'done' && !isDone) return false;
                if (statusFilter === 'not_yet' && isDone) return false;
            }
            return true;
        });

        if(exportList.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë·ªÉ xu·∫•t!");
        if(!confirm(`X√°c nh·∫≠n xu·∫•t ${exportList.length} ƒë·∫°i l√Ω ra file Excel?`)) return;

        const dataRows = exportList.map(s => {
            const isDone = finishedDvns.has(normalize(s.dvn));
            let statusText = "--";
            if(lessonId !== 'all') statusText = isDone ? "ƒê√É H·ªåC" : "CH∆ØA H·ªåC";
            return { "M√£ DVN": s.dvn, "T√™n ƒê·∫°i L√Ω": s.name, "Gi√°m ƒê·ªëc KV": s.director, "Sale Ph·ª• Tr√°ch": s.saleRep, "T·ªânh/Th√†nh": s.province, "Qu·∫≠n/Huy·ªán": s.district, "Lo·∫°i H√¨nh": s.type, "Tr·∫°ng Th√°i": statusText };
        });

        const ws = XLSX.utils.json_to_sheet(dataRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DanhSachDaiLy");
        XLSX.writeFile(wb, `YADEA_DL_${lessonTitle}_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    const checkAdminAuth = async (user) => {
        if (!user) { showLogin(true); return; }
        try {
            const docSnap = await getDoc(doc(db, "users", user.uid));
            if (docSnap.exists() && docSnap.data().role === 'admin') {
                showLogin(false);
                document.getElementById('adminNameDisplay').textContent = docSnap.data().name || 'Admin';
                loadFilterOptions('dashFilterLesson'); loadDashboard(); listenToConversations();
            } else { alert("Kh√¥ng c√≥ quy·ªÅn Admin!"); await signOut(auth); showLogin(true); }
        } catch (e) { alert("L·ªói x√°c th·ª±c: " + e.message); showLogin(true); }
    };
    const showLogin = (show) => {
        if(show) { document.getElementById('adminAuthOverlay').classList.remove('hidden'); document.getElementById('appContainer').classList.add('hidden'); }
        else { document.getElementById('adminAuthOverlay').classList.add('hidden'); document.getElementById('appContainer').classList.remove('hidden'); }
    }
    onAuthStateChanged(auth, (user) => { checkAdminAuth(user); });
    document.getElementById('admLoginBtn').onclick = async () => {
        const e = document.getElementById('admEmail').value, p = document.getElementById('admPass').value;
        if(!e || !p) return;
        if (e === 'vuhuythanh271092@gmail.com') {
            try { await signInWithEmailAndPassword(auth, e, p); } catch (err) {
                if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    if (confirm("K√çCH HO·∫†T QUY·ªÄN ADMIN M·∫∂C ƒê·ªäNH?")) {
                        try {
                            const c = await createUserWithEmailAndPassword(auth, e, p);
                            await setDoc(doc(db, "users", c.user.uid), { uid: c.user.uid, email: e, name: "Super Admin", role: "admin", status: "active", createdAt: serverTimestamp() });
                            alert("ƒê√£ t·∫°o Admin th√†nh c√¥ng!");
                        } catch (createErr) { alert("L·ªói: " + createErr.message); }
                    }
                } else { document.getElementById('admError').textContent = "L·ªói ƒëƒÉng nh·∫≠p: " + err.code; }
            }
        } else {
            try { await signInWithEmailAndPassword(auth, e, p); } catch (err) { document.getElementById('admError').textContent = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!"; }
        }
    };
    document.getElementById('adminLogoutBtn').onclick = () => signOut(auth);

    window.switchTab = function(t) {
        // Auto close sidebar on mobile when clicking a link
        if(window.innerWidth < 768) {
            document.getElementById('mainSidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }

        // RESET CHAT STATE WHEN SWITCHING TABS
        const listCol = document.getElementById('chatListCol');
        const chatCol = document.getElementById('chatAreaCol');
        if(listCol && chatCol) {
             listCol.classList.remove('-translate-x-full'); 
             chatCol.classList.add('translate-x-full'); 
             currentChatUid = null;
        }

        ['viewLessons','viewUsers','viewReports','viewShops','viewDashboard','viewChat','viewProgress','viewGifts','viewSettings'].forEach(x=> {
            const el = document.getElementById(x);
            if(el) el.classList.add('hidden');
        });
        ['tabLessons','tabUsers','tabReports','tabShops','tabDashboard','tabChat','tabProgress','tabGifts','tabSettings'].forEach(x=> {
            const el = document.getElementById(x);
            if(el) el.classList.remove('active');
        });

        document.getElementById('view'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden');
        document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
        
        if(t==='users') { if(userCache.length===0) loadUsers(); loadFilterOptions('filterUserLesson'); }
        if(t==='progress') { if(userCache.length===0) loadUsers(true); loadFilterOptions('progressFilterLesson'); }
        if(t==='reports') { loadFilterOptions('reportFilterLesson'); loadReports(); }
        if(t==='shops') { 
            loadFilterOptions('filterShopLesson'); 
            if(allShopsCache.length===0) fetchShopData().then(loadShops); else loadShops();
        }
        if(t==='dashboard') { loadFilterOptions('dashFilterLesson'); loadDashboard(); }
        if(t==='gifts') loadGifts();
        if(t==='settings') loadSettings();
    }
    async function loadFilterOptions(elementId) { const select = document.getElementById(elementId); if (select.options.length > 1) return; const snap = await getDocs(collection(db, "lessons")); snap.forEach(d => { const opt = document.createElement('option'); opt.value = d.id; opt.textContent = d.data().title; select.appendChild(opt); }); }

    // --- CHAT SYSTEM LOGIC C·∫¨P NH·∫¨T ---
    
    // 1. H√†m nghe tin nh·∫Øn
    let rawChatData = [];
    
    function listenToConversations() {
        const q = query(collection(db, "conversations"), orderBy("updatedAt", "desc"));
        onSnapshot(q, (snapshot) => {
            let unreadCount = 0;
            rawChatData = []; 
            
            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                d.id = docSnap.id;
                rawChatData.push(d);
                if(d.isReadByAdmin === false) unreadCount++;
            });
            
            renderChatList(rawChatData);

            // C·∫≠p nh·∫≠t Badge th√¥ng b√°o (Sidebar & Chat Header)
            const badges = document.querySelectorAll('#chatUnreadCount');
            badges.forEach(b => {
                b.textContent = unreadCount;
                b.classList.toggle('hidden', unreadCount === 0);
            });
        });
    }

    // 2. Render List
    window.filterChatList = (input) => {
        const k = input.value.toLowerCase();
        const filtered = rawChatData.filter(d => (d.studentName && d.studentName.toLowerCase().includes(k)) || (d.dvn && d.dvn.toLowerCase().includes(k)));
        renderChatList(filtered);
    }

    function renderChatList(data) {
        const list = document.getElementById('chatUserList');
        list.innerHTML = "";
        data.forEach(d => {
            const isActive = currentChatUid === d.id ? 'bg-orange-50 border-l-4 border-orange-500' : 'border-l-4 border-transparent hover:bg-gray-50';
            const styleName = d.isReadByAdmin === false ? 'font-bold text-gray-900' : 'text-gray-700';
            const styleMsg = d.isReadByAdmin === false ? 'font-bold text-orange-600' : 'text-gray-400';
            const dot = d.isReadByAdmin === false ? '<div class="w-2.5 h-2.5 rounded-full bg-orange-500"></div>' : '';
            
            list.innerHTML += `
            <div onclick="openChat('${d.id}', '${d.studentName}', '${d.dvn}')" class="chat-user-item p-4 border-b cursor-pointer transition-all ${isActive} flex justify-between items-start group">
                <div class="flex-1 min-w-0 mr-2">
                    <div class="text-sm ${styleName} mb-0.5 truncate">${d.studentName}</div>
                    <div class="text-xs ${styleMsg} truncate flex items-center gap-1">
                        ${d.sender==='admin' ? '<i class="fa-solid fa-reply text-[10px]"></i>' : ''} ${d.lastMessage}
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <span class="text-[10px] text-gray-400">${d.updatedAt ? new Date(d.updatedAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</span>
                    ${dot}
                </div>
            </div>`;
        });
    }

    // 3. Open Chat + Push History State (Fix physical back button)
    window.openChat = (uid, name, dvn) => {
        currentChatUid = uid;
        document.getElementById('chatHeaderName').innerHTML = `<i class="fa-solid fa-circle-user text-gray-400 text-lg"></i> ${name}`;
        document.getElementById('chatHeaderDvn').textContent = `M√£: ${dvn} | ID: ${uid.slice(0,5)}...`;
        
        // Hi·ªán thanh nh·∫≠p li·ªáu
        document.getElementById('adminChatInputBar').classList.remove('hidden');
        document.getElementById('adminChatInput').focus();

        // Mobile Logic: Slide sang khung chat
        const listCol = document.getElementById('chatListCol');
        const chatCol = document.getElementById('chatAreaCol');
        
        if(window.innerWidth < 768) {
            listCol.classList.add('-translate-x-full'); 
            chatCol.classList.remove('translate-x-full'); 
            
            // Push state for physical back button
            history.pushState({chatOpen: true}, "");
        }

        // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
        updateDoc(doc(db, "conversations", uid), { isReadByAdmin: true });
        
        // Render tin nh·∫Øn
        onSnapshot(doc(db, "conversations", uid), (docSnap) => {
            if(docSnap.exists()) {
                const msgs = docSnap.data().messages || [];
                const div = document.getElementById('adminChatMessages');
                div.innerHTML = '';
                
                msgs.forEach(m => {
                    const isMe = m.sender === 'admin';
                    div.innerHTML += `
                    <div class="chat-bubble-admin ${isMe ? 'bubble-me self-end bg-orange-600 text-white rounded-tr-none' : 'bubble-user self-start bg-white border border-gray-200 text-gray-800 rounded-tl-none shadow-sm'} max-w-[85%] p-3 rounded-2xl text-sm mb-1 relative group">
                        ${m.text}
                        <div class="text-[9px] opacity-60 mt-1 text-right">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    </div>`;
                });
                div.scrollTop = div.scrollHeight;
            }
        });
        
        renderChatList(rawChatData);
    }

    // 4. Close Chat Mobile
    window.closeChatMobile = () => {
        currentChatUid = null;
        const listCol = document.getElementById('chatListCol');
        const chatCol = document.getElementById('chatAreaCol');
        
        listCol.classList.remove('-translate-x-full');
        chatCol.classList.add('translate-x-full');
        
        document.getElementById('adminChatInput').blur();
    }
    
    // 5. Handle Physical Back Button
    window.onpopstate = function(event) {
        if(window.innerWidth < 768) {
            closeChatMobile();
        }
    };
    
    // 6. Send Message
    window.sendAdminMsg = async () => {
        if(!currentChatUid) return;
        const input = document.getElementById('adminChatInput');
        const txt = input.value.trim();
        if(!txt) return;
        
        input.value = '';
        input.style.height = 'auto'; 
        
        await updateDoc(doc(db, "conversations", currentChatUid), {
            messages: arrayUnion({ sender: 'admin', text: txt, time: Date.now() }),
            lastMessage: "Admin: " + txt,
            updatedAt: serverTimestamp(),
            isReadByStudent: false
        });
    }

    // 7. Init Emoji
    const emojisAdmin = ["üòÄ","üòÅ","üòÇ","ü§£","üòç","ü•∞","üòé","ü§î","üò≠","üò§","üëç","üëé","üëå","‚ù§","üß°","üíî","üéâ","üî•","‚ú®","‚úÖ","‚ùå","üëã","üôè","üèç"];
    const pickerAdmin = document.getElementById('emojiPickerAdmin');
    if(pickerAdmin) {
        pickerAdmin.innerHTML = '';
        emojisAdmin.forEach(icon => {
            const btn = document.createElement('button');
            btn.className = "hover:bg-gray-100 p-1 rounded text-2xl transition w-8 h-8 flex items-center justify-center";
            btn.textContent = icon;
            btn.onclick = () => {
                const input = document.getElementById('adminChatInput');
                input.value += icon;
                input.focus();
                pickerAdmin.classList.add('hidden');
            };
            pickerAdmin.appendChild(btn);
        });
    }

    async function fetchShopData() {
        if(allShopsCache.length === 0) { 
            const sSnap = await getDocs(collection(db, "shops")); 
            sSnap.forEach(d => {
                const s = d.data();
                allShopsCache.push(s);
                if(s.dvn) shopNameMap[normalize(s.dvn)] = s.name;
            });
        }
    }

    // --- MODIFIED: Load Users with Sort by CreatedAt ---
    window.loadUsers = async function(loadAll = false) { 
        try {
            const tb = document.getElementById('userTableBody'); 
            tb.innerHTML='<tr><td colspan="7" class="p-4 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t...</td></tr>';
            
            await fetchShopData();
            
            if(userCache.length === 0 || loadAll) {
                let q;
                // N·∫øu kh√¥ng load all th√¨ l·∫•y 100 ng∆∞·ªùi m·ªõi nh·∫•t
                if(!loadAll) {
                    q = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(100)); 
                } else {
                    q = query(collection(db, "users"), orderBy("createdAt", "desc"));
                }
                
                const snap = await getDocs(q); 
                userCache = []; 
                snap.forEach(d => userCache.push({id:d.id,...d.data()}));
                
                // S·∫Øp x·∫øp ∆∞u ti√™n tr·∫°ng th√°i 'pending' l√™n ƒë·∫ßu ƒë·ªÉ d·ªÖ duy·ªát
                userCache.sort((a,b)=>{ 
                    const order = { 'pending': 1, 'active': 2, 'banned': 3 }; 
                    return (order[a.status||'active'] || 4) - (order[b.status||'active'] || 4); 
                });
            }
            renderUserTable(); 
        } catch(e) { 
            console.error(e); 
            // B·∫Øt l·ªói thi·∫øu Index c·ªßa Firebase
            if(e.message.includes("requires an index")) {
                alert("H·ªá th·ªëng c·∫ßn t·∫°o Index tr√™n Firebase. Vui l√≤ng m·ªü Console (F12) b·∫•m v√†o link l·ªói ƒë·ªÉ t·∫°o.");
            } else {
                alert("L·ªói t·∫£i User: " + e.message); 
            }
        }
    }
    
    window.renderUserTable = function() {
        const tb = document.getElementById('userTableBody'); 
        const filterStatus = document.getElementById('filterUserStatus').value; 
        const lessonFilterId = document.getElementById('filterUserLesson').value;
        const search = document.getElementById('searchUser').value.toLowerCase();
        
        const colTitle = document.getElementById('colDynamicTitle');
        if (lessonFilterId !== 'all') {
            colTitle.innerHTML = '<span class="text-blue-600"><i class="fa-solid fa-eye"></i> Ti·∫øn ƒë·ªô b√†i h·ªçc</span>';
        } else {
            colTitle.innerHTML = 'ƒêi·ªÉm & Sao';
        }

        const pendingCount = userCache.filter(x=>x.status==='pending').length; 
        document.getElementById('pendingCount').textContent = pendingCount; 
        document.getElementById('pendingCount').classList.toggle('hidden', pendingCount===0);
        
        let displayList = userCache; 
        if(filterStatus !== 'all') displayList = displayList.filter(u => u.status === filterStatus);
        if(search) displayList = displayList.filter(u => (u.name&&u.name.toLowerCase().includes(search)) || (u.dvnCode&&u.dvnCode.toLowerCase().includes(search)));
        
        document.getElementById('userCountBadge') ? document.getElementById('userCountBadge').textContent = `Hi·ªÉn th·ªã ${displayList.length} user` : null; 
        tb.innerHTML = '';
        
        if(displayList.length === 0) { tb.innerHTML='<tr><td colspan="7" class="p-4 text-center text-gray-400">Kh√¥ng t√¨m th·∫•y user n√†o.</td></tr>'; return; }
        
        displayList.forEach(x => { 
            let sttBadge = '', actionBtns = ''; 
            const pts = x.points || 0; const stars = x.stars || 0;
            let nextTarget = 500; if(pts >= 2000) nextTarget = null; else if(pts >= 1600) nextTarget = 2000; else if(pts >= 1200) nextTarget = 1600; else if(pts >= 800) nextTarget = 1200; else if(pts >= 500) nextTarget = 800;
            let dynamicColumnHtml = '';

            if (lessonFilterId !== 'all') {
                const hasStudied = x.completedActivities && x.completedActivities[`study_${lessonFilterId}`];
                if (hasStudied) dynamicColumnHtml = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200 shadow-sm"><i class="fa-solid fa-check"></i> ƒê√É H·ªåC</span>`;
                else dynamicColumnHtml = `<span class="bg-gray-100 text-gray-400 px-3 py-1 rounded-full text-xs font-bold border border-gray-200">CH∆ØA H·ªåC</span>`;
            } else {
                let starHtml = ''; for(let i=0; i<stars; i++) starHtml += '<i class="fa-solid fa-star text-yellow-400 text-[10px]"></i>'; if(stars === 0) starHtml = '<span class="text-gray-300 text-[10px]"><i class="fa-regular fa-star"></i></span>';
                let progressHtml = nextTarget ? `<div class="text-[10px] text-gray-400 mt-1">C·∫ßn <b>${nextTarget - pts}</b>ƒë l√™n sao</div>` : `<div class="text-[10px] text-green-600 font-bold mt-1">MAX LEVEL</div>`;
                
                const editBtn = `<button onclick="openEditUserModal('${x.id}', '${x.name}', ${pts}, ${x.spinsAvailable||0})" class="ml-2 text-gray-400 hover:text-orange-600 transition bg-white border border-gray-200 rounded px-1.5 shadow-sm" title="S·ª≠a ƒëi·ªÉm/l∆∞·ª£t quay"><i class="fa-solid fa-pen"></i></button>`;

                dynamicColumnHtml = `<div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-1">${starHtml}</div>
                        <div class="text-xs font-bold text-gray-700 mt-0.5">${pts} pts <span class="text-gray-300">|</span> <span class="text-blue-600">${x.spinsAvailable||0} spins</span></div>
                        ${progressHtml}
                    </div>
                    ${editBtn}
                </div>`;
            }

            if(x.status === 'pending') { sttBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-orange-100 text-orange-700">Ch·ªù duy·ªát</span>'; actionBtns = `<button onclick="updateStatus('${x.id}','active')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700 shadow">Duy·ªát</button>`; } else if (x.status === 'active') { sttBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700">Ho·∫°t ƒë·ªông</span>'; actionBtns = `<button onclick="resetPwd('${x.email}')" class="text-yellow-600 hover:text-yellow-800 text-xs font-bold mr-2 border border-yellow-200 px-1.5 py-0.5 rounded bg-yellow-50" title="G·ª≠i mail ƒë·ªïi MK"><i class="fa-solid fa-key"></i> Pass</button><button onclick="changeRole('${x.id}','${x.role||'learner'}')" class="text-purple-600 hover:text-purple-800 text-xs font-bold mr-2">Role</button><button onclick="updateStatus('${x.id}','banned')" class="text-red-500 hover:text-red-700 text-xs font-bold">Kh√≥a</button>`; } else { sttBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-700">ƒê√£ kh√≥a</span>'; actionBtns = `<button onclick="updateStatus('${x.id}','active')" class="bg-gray-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-gray-700">M·ªü</button>`; } 
            actionBtns += `<button onclick="deleteUser('${x.id}')" class="text-gray-400 hover:text-red-600 text-xs font-bold ml-2" title="X√≥a"><i class="fa-solid fa-trash"></i></button>`;
            let roleBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px]">NV</span>'; if(x.role === 'sale') roleBadge = '<span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-[10px] font-bold">SALE</span>'; if(x.role === 'director') roleBadge = '<span class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded text-[10px] font-bold">Gƒê</span>'; if(x.role === 'admin') roleBadge = '<span class="bg-black text-white px-2 py-0.5 rounded text-[10px] font-bold">ADMIN</span>';
            tb.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="p-4 font-bold text-gray-900">${x.name||'---'}</td><td class="p-4 text-gray-600">${x.dvnCode||'---'}</td><td class="p-4 text-gray-500">${x.email}</td><td class="p-4">${dynamicColumnHtml}</td><td class="p-4">${roleBadge}</td><td class="p-4">${sttBadge}</td><td class="p-4 text-right">${actionBtns}</td></tr>`; 
        });
    }

    window.loadProgress = async function() {
        const tb = document.getElementById('progressTableBody');
        const lessonId = document.getElementById('progressFilterLesson').value;
        const statusFilter = document.getElementById('progressFilterStatus').value;
        
        await fetchShopData();

        if (lessonId === 'all') {
            tb.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Vui l√≤ng ch·ªçn b√†i h·ªçc ƒë·ªÉ ki·ªÉm tra ti·∫øn ƒë·ªô</td></tr>';
            document.getElementById('progTotal').textContent = 0; document.getElementById('progDone').textContent = 0; document.getElementById('progNot').textContent = 0; document.getElementById('progRate').textContent = '0%';
            return;
        }

        let total = 0, done = 0;
        let rows = '';
        const usersToCheck = userCache.filter(u => u.status === 'active' && u.role !== 'admin');

        usersToCheck.forEach((u, idx) => {
            const hasStudied = u.completedActivities && u.completedActivities[`study_${lessonId}`];
            if (statusFilter === 'done' && !hasStudied) return;
            if (statusFilter === 'not' && hasStudied) return;

            total++;
            if (hasStudied) done++;

            const statusBadge = hasStudied ? `<span class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold border border-green-200">ƒê√É H·ªåC</span>` : `<span class="bg-gray-100 text-gray-400 px-3 py-1 rounded text-xs font-bold border border-gray-200">CH∆ØA H·ªåC</span>`;
            const shopName = shopNameMap[normalize(u.dvnCode)] || '<span class="text-gray-400 italic">Ch∆∞a x√°c ƒë·ªãnh</span>';

            rows += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="p-4 text-gray-500">${idx + 1}</td><td class="p-4 font-bold text-gray-800">${u.name}</td><td class="p-4 text-gray-600 font-mono text-xs">${u.dvnCode || '---'}</td><td class="p-4 text-blue-700 font-bold text-xs">${shopName}</td><td class="p-4 text-center">${statusBadge}</td></tr>`;
        });

        tb.innerHTML = rows || '<tr><td colspan="5" class="p-8 text-center text-gray-400">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</td></tr>';
        
        document.getElementById('progTotal').textContent = total;
        document.getElementById('progDone').textContent = done;
        document.getElementById('progNot').textContent = total - done;
        document.getElementById('progRate').textContent = total > 0 ? Math.round((done/total)*100) + '%' : '0%';
    }

    window.exportProgressExcel = function() {
        const lessonId = document.getElementById('progressFilterLesson').value;
        if (lessonId === 'all') return alert("Vui l√≤ng ch·ªçn b√†i h·ªçc tr∆∞·ªõc khi xu·∫•t Excel!");
        const lessonTitle = document.getElementById('progressFilterLesson').options[document.getElementById('progressFilterLesson').selectedIndex].text;
        
        const data = userCache.filter(u => u.status === 'active' && u.role !== 'admin').map(u => {
            const hasStudied = u.completedActivities && u.completedActivities[`study_${lessonId}`];
            const shopName = shopNameMap[normalize(u.dvnCode)] || 'Ch∆∞a x√°c ƒë·ªãnh';
            return { "H·ªç v√† T√™n": u.name, "M√£ DVN": u.dvnCode, "T√™n ƒê·∫°i L√Ω": shopName, "Email": u.email, "B√†i h·ªçc": lessonTitle, "Tr·∫°ng th√°i": hasStudied ? "ƒê√É H·ªåC" : "CH∆ØA H·ªåC" };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "TienDoDaoTao");
        XLSX.writeFile(wb, `TienDo_${lessonTitle}_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    window.loadShops = async function() { 
        const tb = document.getElementById('shopTableBody'); 
        const lessonId = document.getElementById('filterShopLesson').value; 
        const statusFilter = document.getElementById('filterShopStatus').value; 
        const search = document.getElementById('searchShop').value.toLowerCase(); 
        
        tb.innerHTML = '<tr><td colspan="8" class="p-6 text-center"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>'; 
        
        if(allShopsCache.length === 0) await fetchShopData();
        if(userCache.length === 0) await loadUsers(true);

        let finishedDvns = new Set();
        if(lessonId !== 'all') {
            userCache.forEach(u => {
                if(u.completedActivities && u.completedActivities[`study_${lessonId}`] && u.dvnCode) {
                    finishedDvns.add(normalize(u.dvnCode));
                }
            });
        }
        
        let displayList = allShopsCache.filter(s => { 
            const txt = ((s.dvn||'')+' '+(s.name||'')+' '+(s.saleRep||'')+' '+(s.director||'')+' '+(s.province||'')).toLowerCase(); 
            if (search && !txt.includes(search)) return false;
            
            if (lessonId !== 'all' && statusFilter !== 'all') {
                const isDone = finishedDvns.has(normalize(s.dvn));
                if (statusFilter === 'done' && !isDone) return false;
                if (statusFilter === 'not_yet' && isDone) return false;
            }
            return true;
        }); 
        
        let doneCnt = 0; 
        tb.innerHTML = ''; 
        if(displayList.length === 0) { 
            tb.innerHTML = '<tr><td colspan="8" class="p-6 text-center text-gray-400">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</td></tr>'; 
        } else { 
            displayList.slice(0, 500).forEach(s => { 
                const isDone = lessonId !== 'all' && finishedDvns.has(normalize(s.dvn)); 
                if(isDone) doneCnt++; 
                const statusHtml = lessonId === 'all' ? '<span class="text-gray-400 text-xs">--</span>' : (isDone ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold text-xs">ƒê√É H·ªåC</span>' : '<span class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold text-xs">CH∆ØA H·ªåC</span>'); 
                tb.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="p-4 font-bold text-gray-800">${s.dvn}</td><td class="p-4 text-gray-700 font-medium">${s.name}</td><td class="p-4 text-xs"><div class="font-bold text-gray-700">${s.director || '-'}</div><div class="text-gray-400">GƒêKV</div></td><td class="p-4 text-blue-600 font-medium text-sm">${s.saleRep || '-'}</td><td class="p-4 text-gray-500 text-sm">${s.province || ''} <span class="text-xs text-gray-400">(${s.district || ''})</span></td><td class="p-4 text-center sticky right-0 bg-white shadow-l border-l">${statusHtml}</td><td class="p-4 text-right"><button onclick="deleteShop('${s.dvn}')" class="text-gray-300 hover:text-red-500 transition px-2 py-1"><i class="fa-solid fa-trash"></i></button></td></tr>`; 
            }); 
        } 
        
        if(statusFilter !== 'all' && lessonId !== 'all') {
             document.getElementById('shopStatTotal').textContent = displayList.length;
             document.getElementById('shopStatDone').textContent = statusFilter === 'done' ? displayList.length : 0;
             document.getElementById('shopStatNot').textContent = statusFilter === 'not_yet' ? displayList.length : 0;
             document.getElementById('shopStatRate').textContent = '---';
        } else {
            document.getElementById('shopStatTotal').textContent = displayList.length; 
            if(lessonId !== 'all') { 
                document.getElementById('shopStatDone').textContent = doneCnt; 
                document.getElementById('shopStatNot').textContent = displayList.length - doneCnt; 
                document.getElementById('shopStatRate').textContent = displayList.length > 0 ? Math.round((doneCnt/displayList.length)*100) + '%' : '0%'; 
            } else { 
                document.getElementById('shopStatDone').textContent = '-'; 
                document.getElementById('shopStatNot').textContent = '-'; 
                document.getElementById('shopStatRate').textContent = '-'; 
            } 
        }
    }

    window.deleteShop = async (dvn) => {
        if(confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·∫°i l√Ω ${dvn} n√†y kh·ªèi h·ªá th·ªëng?`)) {
            try {
                await deleteDoc(doc(db, "shops", dvn));
                allShopsCache = allShopsCache.filter(s => s.dvn !== dvn);
                loadShops();
            } catch(e) {
                alert("L·ªói khi x√≥a: " + e.message);
            }
        }
    }

    window.updateStatus = async(id, status) => { if(confirm("Thay ƒë·ªïi tr·∫°ng th√°i?")) { await updateDoc(doc(db,"users",id),{status: status}); loadUsers(true); } }
    window.changeRole = async(id, currentRole) => { const newRole = prompt("Nh·∫≠p vai tr√≤ (learner/sale/director/admin):", currentRole); if(newRole && ['learner','sale','director','admin'].includes(newRole)) { await updateDoc(doc(db,"users",id),{role: newRole}); loadUsers(true); } }
    window.deleteUser = async(id) => { if(confirm("C·∫¢NH B√ÅO: X√ìA Vƒ®NH VI·ªÑN?")) { try { await deleteDoc(doc(db, "users", id)); userCache = userCache.filter(u => u.id !== id); renderUserTable(); } catch(e) { alert("L·ªói: " + e.message); } } }

    // --- FIX: Normalize DVN in Dashboard ---
    window.loadDashboard = async function(refresh = false) { 
        const lessonId = document.getElementById('dashFilterLesson').value; 
        const directorFilter = document.getElementById('dashFilterDirector').value; 
        
        if(allShopsCache.length === 0 || refresh) { 
            allShopsCache = []; 
            const sSnap = await getDocs(collection(db, "shops")); 
            sSnap.forEach(d => allShopsCache.push(d.data())); 
            
            // Re-populate Director Filter
            const directors = [...new Set(allShopsCache.map(s => s.director).filter(Boolean))]; 
            const dSelect = document.getElementById('dashFilterDirector'); 
            dSelect.innerHTML = '<option value="all">-- T·∫•t c·∫£ GƒêKV --</option>'; 
            directors.forEach(d => { 
                const opt=document.createElement('option'); opt.value=d; opt.textContent=d; 
                dSelect.appendChild(opt); 
            }); 
        } 
        
        let rQ = collection(db, "exam_results"); 
        if(lessonId !== 'all') rQ = query(collection(db, "exam_results"), where("lessonId", "==", lessonId)); 
        const rSnap = await getDocs(rQ); 
        const results = []; 
        rSnap.forEach(d => results.push(d.data())); 
        
        let filteredShops = allShopsCache; 
        if(directorFilter !== 'all') filteredShops = filteredShops.filter(s => s.director === directorFilter); 
        
        const shopStats = {}, staffStats = {}, provinceStats = {}; 
        
        // Init Stats with Normalized DVN Key
        filteredShops.forEach(s => { 
            const key = normalize(s.dvn); // Use normalize key
            shopStats[key] = { name: s.name, passed: 0, totalScore: 0, attempts: 0, province: s.province }; 
            
            if(!provinceStats[s.province]) provinceStats[s.province] = { passed: 0, total: 0 }; 
            provinceStats[s.province].total++; 
        }); 
        
        let totalScoreSum = 0, totalAttempts = 0; 
        
        results.forEach(r => { 
            const dvnKey = normalize(r.dvn); // Normalize Result DVN
            
            // Only count if shop exists in filtered list
            if(dvnKey && shopStats[dvnKey]) { 
                const score = r.total < 100 ? Math.round((r.score/r.total)*100) : r.score; 
                
                if(!staffStats[r.uid]) staffStats[r.uid] = { name: r.name, scoreSum: 0, tests: 0, maxScore: 0, shopName: shopStats[dvnKey].name }; 
                staffStats[r.uid].scoreSum += score; 
                staffStats[r.uid].tests++; 
                if(score > staffStats[r.uid].maxScore) staffStats[r.uid].maxScore = score; 
                
                shopStats[dvnKey].totalScore += score; 
                shopStats[dvnKey].attempts++; 
                if(score === 100) shopStats[dvnKey].passed = 1; 
                
                totalScoreSum += score; 
                totalAttempts++; 
            } 
        }); 
        
        const shopPassCount = Object.values(shopStats).filter(s => s.passed > 0).length; 
        document.getElementById('kpiRate').textContent = (filteredShops.length > 0 ? Math.round((shopPassCount / filteredShops.length) * 100) : 0) + '%'; 
        document.getElementById('kpiAvgScore').textContent = totalAttempts > 0 ? (totalScoreSum / totalAttempts).toFixed(1) : 0; 
        document.getElementById('kpiShopPass').textContent = shopPassCount; 
        document.getElementById('kpiShopTotal').textContent = `tr√™n t·ªïng s·ªë ${filteredShops.length} shop`; 
        document.getElementById('kpiUserActive').textContent = Object.keys(staffStats).length; 
        
        const topShops = Object.entries(shopStats)
            .map(([dvn, s]) => ({ name: s.name, avg: s.attempts > 0 ? Math.round(s.totalScore/s.attempts) : 0 }))
            .sort((a,b) => b.avg - a.avg).slice(0, 10); 
            
        const topStaff = Object.values(staffStats)
            .map(s => ({ name: s.name, score: s.maxScore, shop: s.shopName }))
            .sort((a,b) => b.score - a.score).slice(0, 10); 
            
        const provData = Object.entries(provinceStats).map(([prov, dat]) => { 
            const shopsInProv = filteredShops.filter(s => s.province === prov); 
            // Re-calc pass for province
            const passedInProv = shopsInProv.filter(s => shopStats[normalize(s.dvn)] && shopStats[normalize(s.dvn)].passed > 0).length; 
            return { name: prov || 'Ch∆∞a Xƒê', y: shopsInProv.length > 0 ? Math.round((passedInProv/shopsInProv.length)*100) : 0 }; 
        }).sort((a,b) => b.y - a.y); 
        
        renderChart('chartTopShops', 'column', 'Top 10 C·ª≠a H√†ng (ƒêi·ªÉm TB)', topShops.map(s=>s.name), topShops.map(s=>s.avg), '#f97316'); 
        renderChart('chartTopStaff', 'bar', 'Top 10 Nh√¢n Vi√™n (ƒêi·ªÉm Cao)', topStaff.map(s=>`${s.name} (${s.shop})`), topStaff.map(s=>s.score), '#3b82f6'); 
        renderChart('chartRegionMap', 'column', 'T·ª∑ L·ªá Ho√†n Th√†nh (%)', provData.map(s=>s.name), provData.map(s=>s.y), '#10b981'); 
        
        dashboardData = { filteredShops, shopStats }; 
    }
    
    function renderChart(id, type, title, cats, data, color) { Highcharts.chart(id, { chart: { type: type }, title: { text: null }, xAxis: { categories: cats }, yAxis: { title: { text: null } }, series: [{ name: title, data: data, color: color, showInLegend: false }], credits: { enabled: false } }); }
    window.exportKPIDashboard = function() { if(!dashboardData.filteredShops) return alert("Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc!"); const rows = dashboardData.filteredShops.map(s => { const stat = dashboardData.shopStats[normalize(s.dvn)] || { passed: 0, attempts: 0 }; return { "M√£ DVN": s.dvn, "T√™n C·ª≠a H√†ng": s.name, "Gi√°m ƒê·ªëc KV": s.director, "Sale Ph·ª• Tr√°ch": s.saleRep, "T·ªânh/Th√†nh": s.province, "S·ªë L∆∞·ª£t Thi": stat.attempts, "Tr·∫°ng Th√°i": stat.passed > 0 ? "ƒê·∫†T" : "CH∆ØA ƒê·∫†T" }; }); const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "KPI_Report"); XLSX.writeFile(wb, `YADEA_KPI_${new Date().toISOString().slice(0,10)}.xlsx`); }
    let curL = null, loadedQuestions = [], editingQId = null; const els = {t:'inpTitle',c:'inpCategory',d:'inpDuration',u:'inpContentUrl',i:'inpImage', de:'inpDesc', minT: 'inpMinTime'};
    
    // --- MODIFIED: LDLESSONS WITH SORTING ---
    async function ldL() { 
        const l = document.getElementById('lessonList'); 
        l.innerHTML = '<div class="text-center p-4 text-gray-400 text-xs"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>'; 
        
        const s = await getDocs(query(collection(db, "lessons"), orderBy("createdAt", "desc"))); 
        
        cachedAdminLessons = [];
        s.forEach(d => {
            const da = d.data();
            if (da.displayOrder === undefined) da.displayOrder = 9999; 
            cachedAdminLessons.push({ id: d.id, ...da });
        });

        cachedAdminLessons.sort((a, b) => {
            if (a.displayOrder !== b.displayOrder) return a.displayOrder - b.displayOrder;
            return b.createdAt - a.createdAt; 
        });

        renderAdminLessonList(cachedAdminLessons);
    }

    // --- MODIFIED: RENDER LIST WITH MOVE BUTTONS ---
    window.renderAdminLessonList = (list) => {
        const l = document.getElementById('lessonList');
        l.innerHTML = '';
        
        if(list.length === 0) {
            l.innerHTML = '<div class="text-center p-4 text-gray-400 text-xs">Kh√¥ng t√¨m th·∫•y b√†i h·ªçc.</div>';
            return;
        }

        list.forEach((da, index) => {
            let rolesIcon = ''; 
            if(da.targetRoles && da.targetRoles.includes('sale')) rolesIcon += '<span class="text-[10px] bg-orange-100 text-orange-600 px-1 rounded ml-1 font-bold">SALE</span>'; 
            if(da.targetRoles && da.targetRoles.includes('director')) rolesIcon += '<span class="text-[10px] bg-purple-100 text-purple-600 px-1 rounded ml-1 font-bold">Gƒê</span>'; 
            
            const isFirst = index === 0;
            const isLast = index === list.length - 1;
            
            const upBtn = isFirst ? '<span class="w-6"></span>' : `<button onclick="moveLesson('${da.id}', -1, event)" class="w-6 h-6 hover:bg-gray-200 rounded text-gray-500 hover:text-blue-600 transition" title="L√™n tr√™n"><i class="fa-solid fa-chevron-up"></i></button>`;
            const downBtn = isLast ? '<span class="w-6"></span>' : `<button onclick="moveLesson('${da.id}', 1, event)" class="w-6 h-6 hover:bg-gray-200 rounded text-gray-500 hover:text-blue-600 transition" title="Xu·ªëng d∆∞·ªõi"><i class="fa-solid fa-chevron-down"></i></button>`;

            l.innerHTML += `
            <div onclick="sel('${da.id}')" class="group p-2 border rounded-xl cursor-pointer hover:bg-blue-50 hover:border-blue-200 bg-white transition flex gap-3 items-center relative">
                <div class="flex flex-col gap-1 items-center justify-center border-r pr-2 border-gray-100 opacity-30 group-hover:opacity-100 transition">
                    ${upBtn}
                    ${downBtn}
                </div>
                <img src="${da.bannerUrl||da.image}" class="w-10 h-10 rounded-lg object-cover bg-gray-100 border border-gray-200">
                <div class="flex-1 min-w-0">
                    <div class="truncate text-xs font-bold text-gray-800">${da.title}</div>
                    <div class="mt-1 flex items-center">${rolesIcon} <span class="text-[10px] text-gray-400 ml-auto mr-2">${da.duration}p</span></div>
                </div>
            </div>`;
        });
    }

    window.filterAdminLessons = () => {
        const keyword = document.getElementById('searchLessonInput').value.toLowerCase();
        const filtered = cachedAdminLessons.filter(l => l.title.toLowerCase().includes(keyword));
        renderAdminLessonList(filtered);
    }
    
    // --- MODIFIED: MOVE LESSON FUNCTION ---
    window.moveLesson = async (id, direction, event) => {
        event.stopPropagation(); 
        const index = cachedAdminLessons.findIndex(x => x.id === id);
        if (index === -1) return;
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= cachedAdminLessons.length) return;

        const currentItem = cachedAdminLessons[index];
        const targetItem = cachedAdminLessons[targetIndex];

        let order1 = currentItem.displayOrder;
        let order2 = targetItem.displayOrder;

        if(order1 === 9999 || order1 === undefined) order1 = index;
        if(order2 === 9999 || order2 === undefined) order2 = targetIndex;
        if (order1 === order2) { order1 = index; order2 = targetIndex; }

        const temp = order1;
        order1 = order2;
        order2 = temp;

        cachedAdminLessons[index].displayOrder = order1;
        cachedAdminLessons[targetIndex].displayOrder = order2;
        [cachedAdminLessons[index], cachedAdminLessons[targetIndex]] = [cachedAdminLessons[targetIndex], cachedAdminLessons[index]];
        renderAdminLessonList(cachedAdminLessons);

        try {
            await updateDoc(doc(db, "lessons", currentItem.id), { displayOrder: order1 });
            await updateDoc(doc(db, "lessons", targetItem.id), { displayOrder: order2 });
        } catch(e) {
            console.error("L·ªói l∆∞u th·ª© t·ª±:", e);
            ldL(); 
        }
    }

    // --- MODIFIED: TOGGLE SUB INPUT ---
    window.toggleSubInput = () => {
        const cat = document.getElementById('inpCategory').value;
        const sub = document.getElementById('divSubTag');
        if(cat === 'product') sub.classList.remove('hidden');
        else { sub.classList.add('hidden'); document.getElementById('inpSubTag').value = ''; }
    }

    window.sel = async(id) => { const snap = await getDocs(query(collection(db, "lessons"), where("__name__", "==", id))); snap.forEach(doc=>{ const da=doc.data(); curL=id; document.getElementById('formTitle').textContent="S·ª≠a: "+da.title; document.getElementById('btnSaveLesson').textContent="C·∫≠p nh·∫≠t"; document.getElementById('btnDeleteLesson').classList.remove('hidden'); document.getElementById('quizSection').classList.remove('hidden'); document.getElementById(els.t).value=da.title; document.getElementById(els.c).value=da.category; document.getElementById(els.d).value=da.duration; document.getElementById(els.u).value=da.contentUrl; document.getElementById(els.i).value=da.bannerUrl||''; document.getElementById(els.de).value=da.description||''; document.getElementById(els.minT).value = Math.round((da.minStudyTime||300)/60); const roles = da.targetRoles || ['learner']; document.getElementById('roleLearner').checked = roles.includes('learner'); document.getElementById('roleSale').checked = roles.includes('sale'); document.getElementById('roleDirector').checked = roles.includes('director'); 
    
    // Load Subtag
    if(da.category === 'product') {
        document.getElementById('divSubTag').classList.remove('hidden');
        document.getElementById('inpSubTag').value = da.subTag || '';
    } else {
        document.getElementById('divSubTag').classList.add('hidden');
        document.getElementById('inpSubTag').value = '';
    }

    cancelEditQ(); ldQ(id); }); }
    
    window.resetForm = () => { curL=null; cancelEditQ(); document.getElementById('formTitle').textContent="Th√™m m·ªõi"; document.getElementById('btnSaveLesson').textContent="L∆∞u"; document.getElementById('btnDeleteLesson').classList.add('hidden'); document.getElementById('quizSection').classList.add('hidden'); for(let k in els) document.getElementById(els[k]).value=''; document.getElementById('inpMinTime').value = 5; document.getElementById('roleLearner').checked = true; document.getElementById('roleSale').checked = false; document.getElementById('roleDirector').checked = false; document.getElementById('divSubTag').classList.add('hidden'); document.getElementById('inpSubTag').value=''; }
    
    // --- MODIFIED: SAVE LESSON (ADD DISPLAY ORDER 0 AND SUBTAG) ---
    document.getElementById('btnSaveLesson').onclick = async() => { 
        const targetRoles = []; 
        if(document.getElementById('roleLearner').checked) targetRoles.push('learner'); 
        if(document.getElementById('roleSale').checked) targetRoles.push('sale'); 
        if(document.getElementById('roleDirector').checked) targetRoles.push('director'); 
        if(targetRoles.length === 0) targetRoles.push('learner'); 
        
        const minMins = parseInt(document.getElementById(els.minT).value) || 5; 
        const subTag = document.getElementById('inpSubTag').value;
        let desc = document.getElementById(els.de).value;

        // Auto append tag to description so search works in index.html
        if(subTag && !desc.includes(subTag)) {
            desc += ` [${subTag}]`;
        }

        const da = {
            title:document.getElementById(els.t).value, 
            category:document.getElementById(els.c).value, 
            duration:document.getElementById(els.d).value, 
            contentUrl:document.getElementById(els.u).value, 
            bannerUrl:document.getElementById(els.i).value, 
            description: desc, 
            minStudyTime: minMins*60, 
            targetRoles: targetRoles,
            subTag: subTag
        }; 
        
        if(curL) { await updateDoc(doc(db,"lessons",curL),da); } else { da.createdAt=serverTimestamp(); da.displayOrder=0; const r=await addDoc(collection(db,"lessons"),da); curL=r.id; } alert("ƒê√£ l∆∞u"); ldL(); 
    }

    document.getElementById('btnDeleteLesson').onclick = async() => { if(confirm("X√≥a?")) { await deleteDoc(doc(db,"lessons",curL)); resetForm(); ldL(); } }
    async function ldQ(id) { const ql = document.getElementById('questionList'); ql.innerHTML=''; const s = await getDocs(query(collection(db,"questions"),where("lessonId","==",id))); loadedQuestions=[]; s.forEach(d=>{const da=d.data(); da.id=d.id; loadedQuestions.push(da); ql.innerHTML+=`<div class="text-xs border p-3 rounded flex justify-between bg-gray-50"><div class="flex-1 mr-2"><b class="text-gray-800 block mb-1">${da.text}</b><span class="text-green-600 bg-green-50 px-1.5 border border-green-100 rounded">ƒê√∫ng: ${da.options[da.correctIndex]}</span></div><div class="flex gap-2"><button onclick="editQ('${d.id}')" class="text-blue-500 font-bold border border-blue-200 bg-white px-2 rounded">S·ª≠a</button><button onclick="dQ('${d.id}')" class="text-red-500 font-bold border border-red-200 bg-white px-2 rounded">X√≥a</button></div></div>`;}); }
    window.editQ = (id) => { const q = loadedQuestions.find(x => x.id === id); if(!q) return; editingQId = id; document.getElementById('qText').value = q.text; document.getElementById('qOp0').value = q.options[0]; document.getElementById('qOp1').value = q.options[1]; document.getElementById('qOp2').value = q.options[2]; document.getElementById('qOp3').value = q.options[3]; document.getElementById('qCorrect').value = q.correctIndex; const btn = document.getElementById('btnAddQuestion'); btn.textContent = "C·∫≠p nh·∫≠t"; btn.classList.add('bg-blue-600'); document.getElementById('btnCancelEditQ').classList.remove('hidden'); document.getElementById('quizInputBox').classList.add('border-blue-300', 'bg-blue-50'); document.getElementById('qText').focus(); }
    window.cancelEditQ = () => { editingQId = null; document.getElementById('qText').value = ''; document.getElementById('qOp0').value = ''; document.getElementById('qOp1').value = ''; document.getElementById('qOp2').value = ''; document.getElementById('qOp3').value = ''; const btn = document.getElementById('btnAddQuestion'); btn.textContent = "Th√™m c√¢u h·ªèi"; btn.classList.remove('bg-blue-600'); document.getElementById('btnCancelEditQ').classList.add('hidden'); document.getElementById('quizInputBox').classList.remove('border-blue-300', 'bg-blue-50'); }
    document.getElementById('btnAddQuestion').onclick = async() => { const t = document.getElementById('qText').value; if(!t) return alert("Nh·∫≠p c√¢u h·ªèi!"); const qData = {lessonId: curL, text: t, options: [document.getElementById('qOp0').value, document.getElementById('qOp1').value, document.getElementById('qOp2').value, document.getElementById('qOp3').value], correctIndex: parseInt(document.getElementById('qCorrect').value), createdAt: serverTimestamp()}; if(editingQId) { await updateDoc(doc(db, "questions", editingQId), qData); cancelEditQ(); } else { await addDoc(collection(db,"questions"), qData); document.getElementById('qText').value=''; } ldQ(curL); }
    window.dQ = async(id) => { if(confirm("X√≥a c√¢u h·ªèi?")) { await deleteDoc(doc(db,"questions",id)); ldQ(curL); } }
    const findVal = (row, ...keys) => { const rowKeys = Object.keys(row); for (let key of keys) { const match = rowKeys.find(k => k.toLowerCase().trim().includes(key.toLowerCase().trim())); if (match) return row[match]; } return ''; };
    window.handleImportShop = async function(input) { if(!input.files || input.files.length === 0) return; const file = input.files[0]; const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1}); let headerIndex = -1; for(let i = 0; i < Math.min(20, rawData.length); i++) { const rowStr = JSON.stringify(rawData[i]).toLowerCase(); if(rowStr.includes("m√£ c·ª≠a h√†ng") || rowStr.includes("dvn")) { headerIndex = i; break; } } if(headerIndex === -1) return alert("L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt 'M√£ c·ª≠a h√†ng'!"); const jsonData = XLSX.utils.sheet_to_json(firstSheet, {range: headerIndex}); if(!confirm(`T√¨m th·∫•y ti√™u ƒë·ªÅ t·∫°i d√≤ng ${headerIndex + 1}. Nh·∫≠p li·ªáu ngay?`)) return; let count = 0; for(let row of jsonData) { const dvn = findVal(row, 'M√£ c·ª≠a h√†ng', 'DVN', 'Code'); if(dvn) { await setDoc(doc(db, "shops", String(dvn).trim()), { dvn: String(dvn).trim(), name: findVal(row, 'T√™n ƒë·∫°i l√Ω', 'Name'), director: findVal(row, 'Gi√°m ƒë·ªëc', 'GƒêKV'), saleRep: findVal(row, 'Sale', 'Sales'), province: findVal(row, 'T·ªânh', 'City'), district: findVal(row, 'Huy·ªán', 'District'), type: findVal(row, 'Lo·∫°i h√¨nh', 'Type'), area: findVal(row, 'Di·ªán t√≠ch', 'Area'), updatedAt: serverTimestamp() }); count++; } } alert(`Th√†nh c√¥ng: ƒê√£ nh·∫≠p ${count} shop.`); allShopsCache = []; loadShops(); } catch(e) { alert("L·ªói ƒë·ªçc file: " + e.message); } }; reader.readAsArrayBuffer(file); input.value = ''; }
    
    window.loadReports = async function(loadAll = false) { const tb = document.getElementById('reportTableBody'); const filterId = document.getElementById('reportFilterLesson').value; tb.innerHTML='<tr><td colspan="8" class="p-4 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>'; let q = collection(db, "exam_results"); if(!loadAll && filterId === 'all') q = query(collection(db, "exam_results"), orderBy("timestamp", "desc"), limit(200)); const snap = await getDocs(q); let res = []; snap.forEach(d => res.push({id: d.id, ...d.data()})); if (filterId !== 'all') { res = res.filter(r => r.lessonId === filterId); } res.sort((a,b) => { let scoreA = a.total < 100 ? (a.score/a.total)*100 : a.score; let scoreB = b.total < 100 ? (b.score/b.total)*100 : b.score; if(scoreB !== scoreA) return scoreB - scoreA; return (a.duration||9999) - (b.duration||9999); }); currentReportData = res; document.getElementById('statTotal').textContent = res.length; let passCnt = 0; tb.innerHTML = ''; if(res.length === 0) { tb.innerHTML='<tr><td colspan="8" class="p-8 text-center text-gray-400">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>'; return; } res.slice(0, 500).forEach((r,i) => { let m = Math.floor((r.duration||0)/60), s = (r.duration||0)%60; let icon = (i===0?'ü•á':(i===1?'ü•à':(i===2?'ü•â':i+1))); let date = r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleDateString('vi-VN') : ''; let displayScore = r.total < 100 ? Math.round((r.score/r.total)*100) : r.score; let isPass = displayScore === 100; if(isPass) passCnt++; let statusHtml = isPass ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold border border-green-200">PASS</span>' : '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold border border-red-200">FAIL</span>'; tb.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="p-4 text-lg font-bold text-gray-500 text-center">${icon}</td><td class="p-4"><p class="font-bold text-gray-800">${r.name}</p><p class="text-xs text-gray-400">${r.dvn}</p></td><td class="p-4 text-gray-600 max-w-xs truncate" title="${r.lessonTitle}">${r.lessonTitle}</td><td class="p-4 font-bold text-center text-gray-800">${displayScore}</td><td class="p-4 text-center">${statusHtml}</td><td class="p-4 font-mono text-xs text-gray-500">${m}p ${s}s</td><td class="p-4 text-xs text-gray-400">${date}</td><td class="p-4 text-right"><button onclick="deleteResult('${r.id}')" class="text-gray-300 hover:text-red-500 transition px-2 py-1"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); document.getElementById('statPass').textContent = passCnt; document.getElementById('statFail').textContent = res.length - passCnt; }
    window.deleteResult = async(id) => { if(confirm("X√≥a k·∫øt qu·∫£ n√†y?")) { await deleteDoc(doc(db, "exam_results", id)); loadReports(); } }
    window.exportToExcel = function() { if (currentReportData.length < 200 && !confirm("B·∫°n ƒëang xu·∫•t d·ªØ li·ªáu gi·ªõi h·∫°n (200 d√≤ng). B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng? (N√™n b·∫•m 'T·∫£i t·∫•t c·∫£' tr∆∞·ªõc)")) return; const excelData = currentReportData.map((r, index) => { let displayScore = r.total < 100 ? Math.round((r.score/r.total)*100) : r.score; let m = Math.floor((r.duration||0)/60); let s = (r.duration||0)%60; return { "H·∫°ng": index + 1, "T√™n Nh√¢n Vi√™n": r.name, "M√£ DVN": r.dvn, "Email": r.email, "B√†i H·ªçc": r.lessonTitle, "ƒêi·ªÉm S·ªë (100)": displayScore, "Tr·∫°ng Th√°i": displayScore === 100 ? "PASS" : "FAIL", "Th·ªùi gian l√†m": `${m} ph√∫t ${s} gi√¢y`, "Ng√†y thi": r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleDateString('vi-VN') : '' }; }); const ws = XLSX.utils.json_to_sheet(excelData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "KetQuaDaoTao"); XLSX.writeFile(wb, `YADEA_Report_${new Date().toISOString().slice(0,10)}.xlsx`); }

    // --- 1. LOGIC QU·∫¢N L√ù QU√Ä T·∫∂NG (C·∫¨P NH·∫¨T - FIX L·ªåC & EXPORT) ---
    window.loadGifts = async () => {
        const tb = document.getElementById('giftTableBody');
        tb.innerHTML = '<tr><td colspan="7" class="p-6 text-center"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>';
        
        // Fetch data sorted by time
        const snap = await getDocs(query(collection(db, "spin_history"), orderBy("timestamp", "desc"), limit(500)));
        giftHistoryCache = []; 
        
        if(snap.empty) { 
            tb.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-400">Ch∆∞a c√≥ ai tr√∫ng th∆∞·ªüng.</td></tr>'; 
            return; 
        }
        
        snap.forEach(d => {
            const data = d.data();
            data.id = d.id;
            giftHistoryCache.push(data);
        });

        renderGiftTable();
    }

    window.renderGiftTable = () => {
        const tb = document.getElementById('giftTableBody');
        const filter = document.getElementById('filterGiftStatus').value;
        tb.innerHTML = '';

        let displayList = giftHistoryCache;
        
        // Filter logic: Default status is 'pending' if undefined
        if (filter !== 'all') {
            displayList = displayList.filter(g => {
                const status = g.status || 'pending'; // Fix logic l·ªói l·ªçc
                return status === filter;
            });
        }

        if(displayList.length === 0) {
            tb.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-400">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</td></tr>';
            return;
        }

        displayList.forEach(data => {
            const date = data.timestamp ? new Date(data.timestamp.seconds*1000).toLocaleString('vi-VN') : '';
            const isSent = data.status === 'sent';
            const statusHtml = isSent 
                ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">ƒê√£ trao</span>' 
                : '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">Ch·ªù trao</span>';
            const btnHtml = isSent 
                ? `<div class="flex items-center justify-end gap-2"><span class="text-gray-400 text-xs italic">Ho√†n t·∫•t</span> <button onclick="deleteGiftSpin('${data.id}')" class="text-gray-300 hover:text-red-500 transition px-2 py-1"><i class="fa-solid fa-trash"></i></button></div>`
                : `<div class="flex items-center justify-end gap-2"><button onclick="markGiftSent('${data.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700">X√°c nh·∫≠n trao</button> <button onclick="deleteGiftSpin('${data.id}')" class="text-gray-300 hover:text-red-500 transition px-2 py-1"><i class="fa-solid fa-trash"></i></button></div>`;
            
            let shipInfo = '<span class="text-gray-400 text-xs">Ch∆∞a c·∫≠p nh·∫≠t</span>';
            if(data.shippingName || data.shippingPhone) {
                shipInfo = `<div class="text-xs">
                    <div class="font-bold text-gray-800"><i class="fa-solid fa-user"></i> ${data.shippingName || '---'}</div>
                    <div class="text-gray-600"><i class="fa-solid fa-phone"></i> ${data.shippingPhone || '---'}</div>
                    <div class="text-gray-500 truncate max-w-[150px]" title="${data.shippingAddress}"><i class="fa-solid fa-location-dot"></i> ${data.shippingAddress || '---'}</div>
                </div>`;
            }

            tb.innerHTML += `<tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="p-4 text-xs text-gray-500">${date}</td>
                <td class="p-4 font-bold text-gray-800">${data.name}</td>
                <td class="p-4 text-gray-600 font-mono text-xs">${data.dvn}</td>
                <td class="p-4 text-orange-600 font-bold">${data.prize}</td>
                <td class="p-4">${shipInfo}</td>
                <td class="p-4 text-center">${statusHtml}</td>
                <td class="p-4 text-right">${btnHtml}</td>
            </tr>`;
        });
    }

    window.markGiftSent = async (id) => {
        if(confirm("X√°c nh·∫≠n ƒë√£ trao qu√† cho user n√†y?")) {
            await updateDoc(doc(db, "spin_history", id), { status: 'sent' });
            // Update local cache manually to avoid re-fetch
            const item = giftHistoryCache.find(g => g.id === id);
            if(item) item.status = 'sent';
            renderGiftTable();
        }
    }

    window.deleteGiftSpin = async (id) => {
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªãch s·ª≠ tr√∫ng th∆∞·ªüng n√†y?")) {
            try {
                await deleteDoc(doc(db, "spin_history", id));
                giftHistoryCache = giftHistoryCache.filter(g => g.id !== id);
                renderGiftTable();
            } catch(e) {
                alert("L·ªói khi x√≥a: " + e.message);
            }
        }
    }

    // --- FUNCTION XU·∫§T EXCEL QU√Ä T·∫∂NG ---
    window.exportGiftHistory = () => {
        if(giftHistoryCache.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
        
        // Filter before export to match view
        const filter = document.getElementById('filterGiftStatus').value;
        let exportList = giftHistoryCache;
        if (filter !== 'all') {
            exportList = exportList.filter(g => (g.status || 'pending') === filter);
        }

        const data = exportList.map(g => {
            return {
                "Th·ªùi gian": g.timestamp ? new Date(g.timestamp.seconds*1000).toLocaleString('vi-VN') : '',
                "T√™n Nh√¢n Vi√™n (TK)": g.name,
                "M√£ DVN": g.dvn,
                "Ph·∫ßn Qu√†": g.prize,
                "Ng∆∞·ªùi Nh·∫≠n": g.shippingName || '',
                "S·ªë ƒêi·ªán Tho·∫°i": g.shippingPhone || '',
                "ƒê·ªãa Ch·ªâ Giao H√†ng": g.shippingAddress || '',
                "Tr·∫°ng Th√°i": (g.status === 'sent') ? "ƒê√£ trao" : "Ch·ªù trao"
            };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DanhSachTrungThuong");
        XLSX.writeFile(wb, `QuaTang_YADEA_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // --- 2. LOGIC S·ª¨A ƒêI·ªÇM & L∆Ø·ª¢T QUAY (ƒê√É FIX T·ª∞ T√çNH SAO) ---
    let editingUserUid = null;
    window.openEditUserModal = (uid, name, points, spins) => {
        editingUserUid = uid;
        document.getElementById('editPointName').textContent = `User: ${name}`;
        document.getElementById('editInpPoints').value = points;
        document.getElementById('editInpSpins').value = spins || 0;
        document.getElementById('editPointModal').classList.remove('hidden');
    }

    window.saveUserPoints = async () => {
        if(!editingUserUid) return;
        const newPoints = parseInt(document.getElementById('editInpPoints').value) || 0;
        const newSpins = parseInt(document.getElementById('editInpSpins').value) || 0;
        
        // T√çNH L·∫†I SAO
        let newStars = 0;
        if (newPoints >= 2000) newStars = 5;
        else if (newPoints >= 1600) newStars = 4;
        else if (newPoints >= 1200) newStars = 3;
        else if (newPoints >= 800) newStars = 2;
        else if (newPoints >= 500) newStars = 1;

        const btn = document.querySelector('#editPointModal button:last-child');
        btn.textContent = "..."; btn.disabled = true;

        try {
            await updateDoc(doc(db, "users", editingUserUid), {
                points: newPoints,
                spinsAvailable: newSpins,
                stars: newStars
            });
            // Update Local Cache
            const u = userCache.find(x => x.id === editingUserUid);
            if(u) { u.points = newPoints; u.spinsAvailable = newSpins; u.stars = newStars; }
            
            alert(`ƒê√£ c·∫≠p nh·∫≠t: ${newPoints} ƒëi·ªÉm, ${newStars} sao!`);
            document.getElementById('editPointModal').classList.add('hidden');
            renderUserTable(); 
        } catch(e) {
            alert("L·ªói: " + e.message);
        } finally {
            btn.textContent = "L∆∞u thay ƒë·ªïi"; btn.disabled = false;
        }
    }

    // --- 3. LOGIC IMPORT EXCEL TR·∫ÆC NGHI·ªÜM ---
    window.downloadQuizTemplate = () => {
        const wb = XLSX.utils.book_new();
        const ws_data = [
            ["C√¢u h·ªèi", "ƒê√°p √°n A", "ƒê√°p √°n B", "ƒê√°p √°n C", "ƒê√°p √°n D", "ƒê√°p √°n ƒë√∫ng (1=A, 2=B, 3=C, 4=D)"],
            ["Th·ªß ƒë√¥ c·ªßa VN l√† g√¨?", "HCM", "H√† N·ªôi", "ƒê√† N·∫µng", "C·∫ßn Th∆°", "2"],
            ["Yadea l√† h√£ng xe n∆∞·ªõc n√†o?", "Vi·ªát Nam", "M·ªπ", "Trung Qu·ªëc", "ƒê·ª©c", "3"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Mau_Cau_Hoi");
        XLSX.writeFile(wb, "Template_TracNghiem.xlsx");
    }

    window.importQuizExcel = (input) => {
        if(!input.files[0]) return;
        if(!curL) return alert("Vui l√≤ng ch·ªçn ho·∫∑c t·∫°o b√†i h·ªçc tr∆∞·ªõc!");
        
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            
            let count = 0;
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                if(row.length < 6) continue; 
                
                const qText = row[0];
                const ops = [row[1], row[2], row[3], row[4]];
                const correctIdx = parseInt(row[5]) - 1; 

                if(qText && ops[0] && !isNaN(correctIdx)) {
                    await addDoc(collection(db, "questions"), {
                        lessonId: curL,
                        text: String(qText),
                        options: ops.map(String),
                        correctIndex: correctIdx,
                        createdAt: serverTimestamp()
                    });
                    count++;
                }
            }
            alert(`ƒê√£ import th√†nh c√¥ng ${count} c√¢u h·ªèi!`);
            ldQ(curL); 
            input.value = '';
        };
        reader.readAsArrayBuffer(file);
    }

    // --- 4. LOGIC C·∫§U H√åNH H·ªÜ TH·ªêNG ---
    window.saveSystemSettings = async () => {
        const text = document.getElementById('sysNotifText').value;
        const status = document.getElementById('sysNotifStatus').value;
        
        try {
            await setDoc(doc(db, "settings", "global"), {
                notification: text,
                showNotification: status === 'on',
                updatedAt: serverTimestamp()
            });
            alert("ƒê√£ l∆∞u c·∫•u h√¨nh!");
        } catch(e) {
            alert("L·ªói: " + e.message);
        }
    }
    
    const loadSettings = async () => {
        const d = await getDoc(doc(db, "settings", "global"));
        if(d.exists()) {
            document.getElementById('sysNotifText').value = d.data().notification || '';
            document.getElementById('sysNotifStatus').value = d.data().showNotification ? 'on' : 'off';
        }
    }

    ldL(); loadUsers();
  </script>
</body>
</html>
