<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=0" />
  <title>YADEA E-LEARNING</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .sidebar-item.active { background: linear-gradient(90deg, #ea580c 0%, #f97316 100%); color: white; font-weight: 500; box-shadow: 0 4px 10px -2px rgba(249, 115, 22, 0.4); }
    .nav-mobile-btn.active { color: #ea580c; } .nav-mobile-btn.active i { transform: translateY(-2px); }
    .lesson-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
    .quiz-nav-btn { width: 40px; height: 40px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 500; color: #6b7280; transition: all 0.2s; font-size: 14px; }
    .quiz-nav-btn:hover { border-color: #f97316; color: #f97316; } .quiz-nav-btn.active { background-color: #f97316; color: white; border-color: #f97316; } .quiz-nav-btn.answered { border-color: #22c55e; color: #22c55e; background-color: #f0fdf4; } .quiz-nav-btn.active.answered { background-color: #f97316; color: white; }
    .login-input { background-color: #f3f4f6; border: 1px solid transparent; transition: all 0.3s; } .login-input:focus { background-color: white; border-color: #f97316; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1); }
    .fade-anim { transition: opacity 0.5s ease-in-out; }
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; } .toast { transform: translateX(100%); transition: transform 0.3s ease-out; } .toast.show { transform: translateX(0); }
    .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Avatar Upload Style */
    .avatar-upload:hover .avatar-overlay { opacity: 1; }
    .avatar-overlay { opacity: 0; transition: opacity 0.3s; background: rgba(0,0,0,0.5); }

    /* CSS CHO MOBILE CHIPS */
    .chip-btn { transition: all 0.2s; border: 1px solid #f3f4f6; }
    .chip-btn.active { background-color: #2f3640; color: white; border-color: #2f3640; box-shadow: 0 4px 10px -2px rgba(0,0,0,0.2); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

    /* CHAT SYSTEM STYLES */
    .chat-btn-float { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: #f97316; border-radius: 50%; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; cursor: pointer; transition: transform 0.2s; z-index: 40; }
    .chat-btn-float:hover { transform: scale(1.1); }
    .chat-box-container { position: fixed; bottom: 100px; right: 20px; width: 350px; height: 500px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 41; display: flex; flex-direction: column; overflow: hidden; transform-origin: bottom right; transition: all 0.3s ease; opacity: 0; pointer-events: none; transform: scale(0.8); border: 1px solid #e5e7eb; }
    .chat-box-container.open { opacity: 1; pointer-events: auto; transform: scale(1); bottom: 150px; }
    .msg-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 13px; margin-bottom: 8px; line-height: 1.4; position: relative; word-wrap: break-word; }
    .msg-sent { background: #f97316; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-received { background: #f3f4f6; color: #374151; align-self: flex-start; border-bottom-left-radius: 2px; }
    @media (min-width: 768px) { .chat-box-container.open { bottom: 90px; } .chat-btn-float { bottom: 30px; } }
  </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-700">

  <div id="toast-container" class="flex flex-col gap-2"></div>

  <header class="bg-white border-b border-gray-200 h-16 flex-shrink-0 z-30 relative">
    <div class="max-w-[1600px] mx-auto h-full px-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-7 w-auto object-contain">
        <div class="hidden sm:block">
          <h1 class="font-bold text-gray-800 text-base leading-tight">YADEA E-LEARNING</h1>
          <p class="text-[10px] text-gray-500 font-medium tracking-wider uppercase">Training Center</p>
        </div>
      </div>
      
      <div class="flex items-center gap-4">
        <div class="hidden md:flex items-center gap-4 text-right cursor-pointer hover:bg-gray-50 p-1 pr-3 rounded-full transition" onclick="openProfileModal()">
            <div class="flex items-center gap-3 bg-gray-50 px-3 py-1 rounded-lg border border-gray-100">
                <div class="text-center"><div class="text-[10px] text-gray-400 uppercase font-bold">ƒêi·ªÉm</div><div class="text-sm font-bold text-orange-600" id="userPoints">0</div></div>
                <div class="w-[1px] h-6 bg-gray-200"></div>
                <div class="text-center"><div class="text-[10px] text-gray-400 uppercase font-bold">Danh hi·ªáu</div><div class="text-xs font-bold text-yellow-500" id="userStars">...</div></div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <div id="userName" class="text-sm font-bold text-gray-800">Kh√°ch</div>
                    <div id="userDvn" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full inline-block"></div>
                </div>
                <img id="headerAvatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full object-cover border border-gray-200">
            </div>
        </div>
        
        <div class="md:hidden flex items-center gap-2">
             <div class="flex items-center gap-2 mr-1 cursor-pointer" onclick="openProfileModal()">
                 <img id="headerAvatarMobile" src="https://ui-avatars.com/api/?name=User&background=random" class="w-8 h-8 rounded-full object-cover border border-gray-200">
                 <div class="text-xs font-bold text-orange-600" id="userPointsMobile">0 pts</div>
             </div>
             <button id="logoutBtn" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
        </div>
        <button id="logoutBtnDesktop" class="hidden md:flex w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 items-center justify-center transition text-gray-600" title="ƒêƒÉng xu·∫•t"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
      </div>
    </div>
  </header>

  <div class="flex-1 flex max-w-[1600px] mx-auto w-full overflow-hidden">
    
    <aside class="hidden md:flex w-64 flex-col bg-[#111827] text-gray-300 flex-shrink-0 h-full p-6">
      <h2 class="text-[11px] font-bold text-gray-500 uppercase tracking-widest mb-4">Danh m·ª•c ƒë√†o t·∫°o</h2>
      <nav class="space-y-2">
        <button class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl transition text-sm" data-category="all" onclick="resetSidebarActive(this); mobileFilter('all', null)"><i class="fa-solid fa-layer-group w-5 text-center"></i> T·∫•t c·∫£ b√†i h·ªçc</button>
        
        <button class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition text-sm" data-category="video" onclick="resetSidebarActive(this); mobileFilter('video', null)"><i class="fa-solid fa-circle-play w-5 text-center"></i> H·ªçc qua Video</button>
        
        <div class="relative">
            <button id="btnProductParent" onclick="toggleSubMenu('product-submenu', this)" class="sidebar-item w-full flex items-center justify-between px-4 py-3 rounded-xl transition text-sm group" data-category="product">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-motorcycle w-5 text-center"></i> 
                    <span>Ki·∫øn th·ª©c s·∫£n ph·∫©m</span>
                </div>
                <i class="fa-solid fa-chevron-down text-xs transition-transform duration-300"></i>
            </button>
            
            <div id="product-submenu" class="hidden flex-col mt-1 space-y-1 pl-4 border-l-2 border-gray-700 ml-6 overflow-hidden transition-all duration-300 bg-[#1f2937] rounded-lg py-2">
                <button onclick="filterSubCategory('product', '2025')" class="w-full text-left px-4 py-2 text-xs text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition flex items-center gap-2"><i class="fa-regular fa-calendar text-[10px]"></i> S·∫£n ph·∫©m 2025</button>
                <button onclick="filterSubCategory('product', '2026')" class="w-full text-left px-4 py-2 text-xs text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition flex items-center gap-2"><i class="fa-regular fa-calendar-plus text-[10px]"></i> S·∫£n ph·∫©m 2026</button>
                <button onclick="filterSubCategory('product', 'xe-dien')" class="w-full text-left px-4 py-2 text-xs text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition flex items-center gap-2"><i class="fa-solid fa-bolt text-[10px]"></i> Xe m√°y ƒëi·ªán</button>
                <button onclick="filterSubCategory('product', 'xe-dap-dien')" class="w-full text-left px-4 py-2 text-xs text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition flex items-center gap-2"><i class="fa-solid fa-bicycle text-[10px]"></i> Xe ƒë·∫°p ƒëi·ªán</button>
                <div class="border-t border-gray-600 my-1"></div>
                <button onclick="filterSubCategory('product', '')" class="w-full text-left px-4 py-2 text-xs text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition font-bold">Xem t·∫•t c·∫£</button>
            </div>
        </div>
        <button class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition text-sm" data-category="culture" onclick="resetSidebarActive(this); mobileFilter('culture', null)"><i class="fa-solid fa-landmark w-5 text-center"></i> VƒÉn ho√° & Quy ƒë·ªãnh</button>
        <button class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition text-sm" data-category="skill" onclick="resetSidebarActive(this); mobileFilter('skill', null)"><i class="fa-solid fa-graduation-cap w-5 text-center"></i> K·ªπ nƒÉng b√°n h√†ng</button>
        <div class="pt-4 mt-4 border-t border-gray-700"><button class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition text-sm" data-category="results" onclick="resetSidebarActive(this); mobileFilter('results', null)"><i class="fa-solid fa-chart-line w-5 text-center"></i> K·∫øt qu·∫£ h·ªçc t·∫≠p</button></div>
      </nav>
      <div class="mt-auto pt-6 border-t border-gray-800"><button class="w-full bg-white text-gray-900 text-xs font-bold py-2.5 rounded-lg hover:bg-gray-100 transition">Li√™n h·ªá Admin</button></div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-white md:bg-gray-50 pb-20 md:pb-0">
      
      <div id="mobileFilterBar" class="md:hidden hidden flex-shrink-0 bg-white border-b border-gray-100 px-4 py-3 overflow-x-auto hide-scroll gap-3 sticky top-0 z-20 shadow-[0_4px_6px_-4px_rgba(0,0,0,0.05)]">
          <button onclick="applyMobileSubFilter('', this)" class="chip-btn active whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-50 text-xs font-bold text-gray-500">T·∫•t c·∫£</button>
          <button onclick="applyMobileSubFilter('2025', this)" class="chip-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-50 text-xs font-bold text-gray-500">‚ú® 2025</button>
          <button onclick="applyMobileSubFilter('2026', this)" class="chip-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-50 text-xs font-bold text-gray-500">üî• 2026</button>
          <button onclick="applyMobileSubFilter('xe-dien', this)" class="chip-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-50 text-xs font-bold text-gray-500">‚ö° Xe m√°y ƒëi·ªán</button>
          <button onclick="applyMobileSubFilter('xe-dap-dien', this)" class="chip-btn whitespace-nowrap px-4 py-1.5 rounded-full bg-gray-50 text-xs font-bold text-gray-500">üö≤ Xe ƒë·∫°p ƒëi·ªán</button>
      </div>

      <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth" id="mainScroll">
        
        <section id="heroSection" class="bg-white rounded-3xl p-1 shadow-sm border border-gray-200">
           <div class="relative rounded-[20px] overflow-hidden bg-gray-900 text-white min-h-[200px] md:min-h-[280px] flex items-end group">
              <img id="heroImage" src="" class="absolute inset-0 w-full h-full object-cover opacity-60 fade-anim transition-transform duration-[20000ms] ease-linear group-hover:scale-110">
              <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
              <div class="relative z-10 p-6 md:p-8 w-full md:w-2/3">
                 <span id="heroBadge" class="bg-orange-500 text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block uppercase tracking-wider fade-anim">N·ªîI B·∫¨T</span>
                 <h2 id="heroTitle" class="text-2xl md:text-3xl font-bold mb-2 fade-anim">Loading...</h2>
                 <p id="heroDesc" class="text-gray-300 text-sm mb-4 line-clamp-2 fade-anim">...</p>
                 <div class="flex flex-col sm:flex-row gap-3">
                    <button id="heroStartBtn" class="bg-white text-gray-900 px-6 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-100 transition shadow-lg"><i class="fa-solid fa-play text-orange-500 mr-2"></i> H·ªçc ngay</button>
                    <input id="searchInput" type="text" placeholder="T√¨m b√†i h·ªçc..." class="bg-gray-800/60 border border-gray-600 rounded-xl px-4 py-2.5 text-sm text-white focus:outline-none focus:border-orange-500 transition w-full sm:max-w-xs placeholder-gray-400 backdrop-blur-sm">
                 </div>
              </div>
              <div id="heroDots" class="absolute bottom-6 right-6 flex gap-2 z-20"></div>
           </div>
        </section>

        <section id="listView">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><span class="w-1.5 h-6 bg-orange-500 rounded-full"></span> Danh s√°ch b√†i h·ªçc (<span id="lessonCount">0</span>)</h3>
            <div id="lessonList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-5 md:gap-6"></div>
        </section>

        <section id="detailView" class="hidden flex flex-col gap-6 pb-20">
            <div class="flex justify-between items-center">
                <button id="backToListBtn" class="flex items-center gap-2 text-sm text-gray-500 hover:text-orange-600 w-fit transition pl-1"><i class="fa-solid fa-arrow-left"></i> <span>Quay l·∫°i</span></button>
                <div id="studyTimerBox" class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                    <i class="fa-solid fa-stopwatch text-orange-500 animate-pulse"></i>
                    <div class="text-xs"><span class="text-gray-400 block font-bold" style="font-size: 10px;">TH·ªúI GIAN</span><span id="studyTimeDisplay" class="font-mono font-bold text-gray-800">00:00</span> / <span id="studyTargetDisplay">00:00</span></div>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 md:p-5 border-b bg-gray-50 flex justify-between items-center"><div><h2 id="detailTitle" class="font-bold text-lg md:text-xl text-gray-900"></h2><p id="detailInfo" class="text-xs text-gray-500 mt-1 font-medium"></p></div></div>
                <div id="lessonViewer" class="aspect-video bg-black flex items-center justify-center text-gray-500 text-sm">Loading...</div>
                <div class="p-5 text-sm text-gray-600 bg-white border-t leading-relaxed" id="detailDesc"></div>
            </div>
            
            <div id="startQuizBtnContainer" class="flex justify-center py-6">
                <button onclick="startQuiz()" class="bg-gray-900 hover:bg-black text-white px-8 py-3 rounded-xl font-bold text-sm shadow-lg flex items-center gap-3 transition transform active:scale-95"><span>B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</span> <i class="fa-solid fa-arrow-right"></i></button>
            </div>
            
            <div id="quizSectionContainer" class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hidden">
                <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-4 py-3 md:px-6 md:py-4 flex justify-between items-center">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-file-pen text-lg"></i><span class="font-bold text-sm md:text-base uppercase tracking-wide">B√†i ki·ªÉm tra</span></div>
                    <div class="flex items-center gap-2 bg-black/20 px-3 py-1.5 rounded-lg border border-white/10"><i class="fa-regular fa-clock text-xs"></i><span id="quizTimerDisplay" class="font-mono font-bold text-sm">00:00</span></div>
                </div>
                <div class="p-4 md:p-8 min-h-[250px] flex flex-col justify-center bg-white"><div id="quizContent" class="max-w-4xl mx-auto w-full"></div></div>
                <div class="bg-gray-50 border-t border-gray-200 p-4 md:p-6">
                    <div class="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-wrap gap-2 justify-center" id="quizPagination"></div>
                        <button id="submitQuizBtn" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold text-sm shadow-lg shadow-red-600/20 transition transform active:scale-95 flex items-center justify-center gap-2"><span>N·ªòP B√ÄI</span> <i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                    <div id="quizResult" class="mt-6 text-center hidden"></div>
                </div>
            </div>
        </section>

        <section id="resultView" class="hidden flex flex-col gap-6 h-full">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 border-b pb-4">K·∫æT QU·∫¢ H·ªåC T·∫¨P</h2>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse min-w-[600px]"><thead class="bg-gray-50 text-xs uppercase text-gray-500"><tr><th class="p-4 font-semibold border-b">Kh√≥a h·ªçc</th><th class="p-4 font-semibold border-b text-center">ƒêi·ªÉm s·ªë</th><th class="p-4 font-semibold border-b text-center">Th·ªùi gian</th><th class="p-4 font-semibold border-b text-center">Ng√†y thi</th><th class="p-4 font-semibold border-b text-center">K·∫øt qu·∫£</th></tr></thead><tbody id="myResultTable" class="text-sm text-gray-700 divide-y divide-gray-100"></tbody></table></div>
                <div id="emptyResult" class="hidden p-10 text-center text-gray-400">B·∫°n ch∆∞a ho√†n th√†nh b√†i thi n√†o.</div>
            </div>
            <div class="flex justify-end mt-2 pb-10"><div class="bg-white border border-gray-800 w-full max-w-md rounded-lg overflow-hidden shadow-lg"><table class="w-full text-sm"><thead class="bg-[#111827] text-white"><tr><th class="p-3 text-left font-semibold">T·ªïng c·ªông</th><th class="p-3 text-center font-semibold">S·ªë kh√≥a</th><th class="p-3 text-center font-semibold">ƒêi·ªÉm TB</th><th class="p-3 text-center font-semibold">X·∫øp lo·∫°i</th></tr></thead><tbody><tr><td class="p-3 font-bold text-gray-800">K·∫øt qu·∫£ chung</td><td id="sumCount" class="p-3 text-center">0</td><td id="sumAvg" class="p-3 text-center font-bold text-blue-600">0.0</td><td id="sumRank" class="p-3 text-center font-bold text-orange-600">---</td></tr></tbody></table></div></div>
        </section>

      </div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-between items-center px-4 py-2 z-50 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
        <button class="nav-mobile-btn active flex-1 flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="mobileFilter('all', this)">
            <i class="fa-solid fa-house text-lg mb-0.5"></i>
            <span class="text-[9px] font-bold uppercase tracking-wide">Home</span>
        </button>
        <button class="nav-mobile-btn flex-1 flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="mobileFilter('video', this)">
            <i class="fa-solid fa-circle-play text-lg mb-0.5"></i>
            <span class="text-[9px] font-bold uppercase tracking-wide">Video</span>
        </button>
        <button class="nav-mobile-btn flex-1 flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="mobileFilter('product', this)">
            <i class="fa-solid fa-motorcycle text-lg mb-0.5"></i>
            <span class="text-[9px] font-bold uppercase tracking-wide">S·∫£n ph·∫©m</span>
        </button>
        <button class="nav-mobile-btn flex-1 flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="mobileFilter('skill', this)">
            <i class="fa-solid fa-graduation-cap text-lg mb-0.5"></i>
            <span class="text-[9px] font-bold uppercase tracking-wide">K·ªπ nƒÉng</span>
        </button>
        <button class="nav-mobile-btn flex-1 flex flex-col items-center gap-1 text-gray-400 transition py-1" onclick="mobileFilter('results', this)">
            <i class="fa-solid fa-chart-pie text-lg mb-0.5"></i>
            <span class="text-[9px] font-bold uppercase tracking-wide">K·∫øt qu·∫£</span>
        </button>
    </nav>
  </div>

  <button id="chatBtn" onclick="toggleChat()" class="chat-btn-float hidden"><i class="fa-solid fa-comments"></i><div id="chatUnreadDot" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-600 rounded-full border border-white"></div></button>
  <div id="chatBox" class="chat-box-container">
      <div class="h-14 bg-gradient-to-r from-orange-600 to-red-600 text-white flex items-center justify-between px-4 flex-shrink-0">
          <div class="font-bold flex items-center gap-2"><i class="fa-solid fa-headset"></i> H·ªó tr·ª£ Admin</div>
          <button onclick="toggleChat()" class="opacity-80 hover:opacity-100"><i class="fa-solid fa-xmark text-lg"></i></button>
      </div>
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col">
          <div class="text-center text-xs text-gray-400 my-4">B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán</div>
      </div>
      <div class="p-3 border-t bg-white flex gap-2 items-center relative">
          <button onclick="document.getElementById('emojiPickerUser').classList.toggle('hidden')" class="w-10 h-10 rounded-full text-gray-400 hover:text-orange-600 hover:bg-gray-100 transition flex-shrink-0 flex items-center justify-center">
              <i class="fa-regular fa-face-smile text-xl"></i>
          </button>

          <div id="emojiPickerUser" class="hidden absolute bottom-16 left-2 bg-white border border-gray-200 shadow-xl rounded-xl p-2 w-64 grid grid-cols-6 gap-1 z-50 animate-fade-in">
              </div>

          <input id="chatInput" type="text" class="flex-1 border rounded-full px-4 py-2 text-sm outline-none focus:border-orange-500 bg-gray-50 h-10" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendChatMsg()">
          
          <button onclick="sendChatMsg()" class="w-10 h-10 rounded-full bg-orange-600 text-white flex items-center justify-center hover:bg-orange-700 shadow flex-shrink-0">
              <i class="fa-solid fa-paper-plane text-xs"></i>
          </button>
      </div>
  </div>

  <div id="profileModal" class="hidden fixed inset-0 bg-gray-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl animate-fade-in">
          <div class="h-24 bg-gradient-to-r from-orange-500 to-red-600 relative">
              <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="absolute top-3 right-3 text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
          </div>
          <div class="px-6 pb-6 -mt-12 text-center">
              <div class="relative inline-block avatar-upload cursor-pointer group" onclick="document.getElementById('avatarInput').click()">
                  <img id="profileAvatarPreview" src="" class="w-24 h-24 rounded-full border-4 border-white shadow-md object-cover bg-white">
                  <div class="avatar-overlay absolute inset-0 rounded-full flex items-center justify-center text-white"><i class="fa-solid fa-camera"></i></div>
                  <input type="file" id="avatarInput" hidden accept="image/*" onchange="handleImageUpload(this)">
              </div>
              <h3 class="font-bold text-lg mt-2 text-gray-800" id="profileNameDisplay">User Name</h3>
              <p class="text-xs text-gray-500 uppercase font-bold" id="profileDvnDisplay">DVN CODE</p>
              
              <div class="mt-6 space-y-4 text-left">
                  <div>
                      <label class="text-xs font-bold text-gray-500 ml-1">H·ªç v√† t√™n</label>
                      <input id="profName" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-orange-500 outline-none">
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                      <div><label class="text-xs font-bold text-gray-500 ml-1">Ng√†y sinh</label><input id="profDob" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none"></div>
                      <div><label class="text-xs font-bold text-gray-500 ml-1">S·ªë ƒëi·ªán tho·∫°i</label><input id="profPhone" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none"></div>
                  </div>
                  <div>
                      <label class="text-xs font-bold text-gray-500 ml-1">S·ªü th√≠ch</label>
                      <input id="profInterest" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none" placeholder="V√≠ d·ª•: ƒê·ªçc s√°ch, ƒê√° b√≥ng...">
                  </div>
              </div>
              <button onclick="saveProfile()" class="w-full mt-6 bg-gray-900 text-white py-3 rounded-xl font-bold hover:bg-black transition shadow-lg">C·∫≠p nh·∫≠t h·ªì s∆°</button>
          </div>
      </div>
  </div>

  <div id="authOverlay" class="fixed inset-0 bg-gray-100 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col md:flex-row h-auto md:min-h-[500px]">
        <div class="hidden md:flex md:w-5/12 bg-white flex-col items-center justify-center p-8 border-r border-gray-100 text-center">
            <img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="w-24 md:w-32 mb-6 object-contain">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">YADEA E-LEARNING</h2>
            <p class="text-sm text-gray-500">Electrify Your Life</p>
        </div>
        <div class="w-full md:w-7/12 p-6 md:p-12 flex flex-col justify-center">
            <div class="md:hidden flex flex-col items-center mb-6 border-b pb-4"><img src="https://raw.githubusercontent.com/vuhuythanh/tichdiem/refs/heads/main/logo%20YADEA.png" class="h-8 mb-2"><h3 class="font-bold text-gray-800">YADEA E-LEARNING</h3></div>
            <div class="mb-6"><h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-1">Welcome</h3><p class="text-sm text-gray-500">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.</p></div>
            <div class="space-y-4">
                <div><label class="block text-xs font-semibold text-gray-600 mb-1">Email</label><input id="loginEmail" type="email" class="login-input w-full rounded-lg px-4 py-3 text-sm outline-none" placeholder="Enter your email"></div>
                <div><label class="block text-xs font-semibold text-gray-600 mb-1">Password</label><input id="loginPassword" type="password" class="login-input w-full rounded-lg px-4 py-3 text-sm outline-none" placeholder="Enter your password"></div>
                <button id="loginBtn" class="w-full bg-orange-600 text-white font-bold py-3 rounded-lg hover:bg-orange-700 shadow-lg shadow-orange-500/20 transition transform active:scale-95 text-sm uppercase tracking-wide">Sign In</button>
                <p id="loginError" class="text-center text-xs text-red-500 font-medium h-4 mt-2"></p>
                <div class="flex justify-between items-center text-xs pt-2"><button class="text-orange-600 font-medium hover:underline">Qu√™n m·∫≠t kh·∫©u?</button><button id="openRegister" class="text-gray-500 hover:text-gray-800">ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</button></div>
            </div>
            <div id="registerBox" class="hidden mt-6 pt-6 border-t border-dashed border-gray-200 space-y-3">
                <p class="text-xs font-bold text-gray-800 uppercase text-center mb-2">ƒêƒÉng k√Ω th√†nh vi√™n</p>
                <div class="grid grid-cols-2 gap-3"><input id="regName" placeholder="H·ªç t√™n" class="login-input w-full rounded-lg px-3 py-2 text-xs outline-none"><input id="regDvn" placeholder="M√£ DVN" class="login-input w-full rounded-lg px-3 py-2 text-xs outline-none"></div>
                <select id="regRole" class="login-input w-full rounded-lg px-3 py-2 text-xs outline-none text-gray-600 cursor-pointer"><option value="" disabled selected>-- Ch·ªçn ch·ª©c v·ª• / Vai tr√≤ --</option><option value="learner">Nh√¢n Vi√™n C·ª≠a H√†ng</option><option value="sale">Nh√¢n vi√™n Kinh doanh (Sale)</option><option value="director">Gi√°m ƒë·ªëc Khu v·ª±c (Director)</option></select>
                <input id="regEmail" placeholder="Email ƒëƒÉng k√Ω" class="login-input w-full rounded-lg px-3 py-2 text-xs outline-none"><input id="regPassword" type="password" placeholder="M·∫≠t kh·∫©u" class="login-input w-full rounded-lg px-3 py-2 text-xs outline-none"><button id="registerBtn" class="w-full bg-gray-800 text-white py-2.5 rounded-lg text-xs font-bold hover:bg-black">G·ª≠i y√™u c·∫ßu duy·ªát</button>
            </div>
        </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where, serverTimestamp, addDoc, orderBy, updateDoc, increment, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCJj_0-dVddgNBwPsm662guADskM5N9Q6I", authDomain: "e-learning-8d182.firebaseapp.com", projectId: "e-learning-8d182", storageBucket: "e-learning-8d182.firebasestorage.app", messagingSenderId: "1008025386680", appId: "1:1008025386680:web:5c91aa14e056e4578b7e4d", measurementId: "G-L6P2B51170" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

    let currentUser = null, allLessons = [], currentCategory = 'all', currentLesson = null;
    let currentQuestions = [], userAnswers = {}, currentQIdx = 0, quizStartTime = null, quizTimerInterval = null;
    let studyInterval = null, studySeconds = 0, isUserActive = true, idleTimer = null, heroInterval = null, heroIndex = 0, featuredLessons = [];
    let isChatOpen = false;
    let currentSubFilter = null; // New variable for sub-filtering

    // --- CONFIG: BEAUTIFUL BADGES ---
    const categoryConfig = {
        'product': { label: 'Ki·∫øn th·ª©c S·∫£n ph·∫©m', color: 'bg-blue-50 text-blue-700 border-blue-200' },
        'skill':   { label: 'K·ªπ nƒÉng B√°n h√†ng',   color: 'bg-emerald-50 text-emerald-700 border-emerald-200' },
        'culture': { label: 'VƒÉn h√≥a & Quy ƒë·ªãnh', color: 'bg-purple-50 text-purple-700 border-purple-200' },
        'video':   { label: 'Video ƒê√†o t·∫°o',      color: 'bg-red-50 text-red-700 border-red-200' },
        'default': { label: 'Kh√°c',               color: 'bg-gray-50 text-gray-600 border-gray-200' }
    };

    // --- UTILS: SHUFFLE ARRAY (FOR QUIZ) ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- SIDEBAR & FILTER HELPER (FIXED) ---
    window.resetSidebarActive = (clickedBtn) => {
        // Reset t·∫•t c·∫£ n√∫t (bao g·ªìm c·∫£ n√∫t cha c·ªßa menu con)
        document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
        if(clickedBtn) clickedBtn.classList.add('active');
        
        // N·∫øu kh√¥ng b·∫•m v√†o n√∫t cha "S·∫£n ph·∫©m", th√¨ ƒë√≥ng menu con l·∫°i
        const btnProductParent = document.getElementById('btnProductParent');
        const subMenu = document.getElementById('product-submenu');
        
        // Ki·ªÉm tra xem n√∫t ƒë∆∞·ª£c b·∫•m c√≥ ph·∫£i l√† n√∫t m·ªü menu con kh√¥ng
        if (clickedBtn && clickedBtn.id !== 'btnProductParent') {
             subMenu.classList.add('hidden');
             const arrow = btnProductParent.querySelector('.fa-chevron-down');
             if(arrow) arrow.style.transform = 'rotate(0deg)';
        }
    };

    window.toggleSubMenu = (id, btn) => {
        const el = document.getElementById(id);
        const arrow = btn.querySelector('.fa-chevron-down');
        
        const isHidden = el.classList.contains('hidden');
        if (isHidden) {
            el.classList.remove('hidden');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            el.classList.add('hidden');
            arrow.style.transform = 'rotate(0deg)';
        }
        
        // Active visual for parent button
        document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Load default all products
        currentCategory = 'product';
        currentSubFilter = null;
        renderLessons();
    };

    window.filterSubCategory = (parentCat, keyword) => {
        currentCategory = parentCat;
        currentSubFilter = keyword;
        
        // Highlight active sub-button (optional styling)
        const buttons = document.getElementById('product-submenu').querySelectorAll('button');
        buttons.forEach(b => {
            // Reset style
            b.classList.remove('text-white', 'bg-gray-700'); 
            b.classList.add('text-gray-400');
            
            // Check logic
            const btnText = b.textContent.toLowerCase();
            const keyCheck = keyword.replace(/-/g, ' ').toLowerCase();
            
            // Logic so kh·ªõp ƒë∆°n gi·∫£n ƒë·ªÉ highlight
            if((keyword === '' && btnText.includes('t·∫•t c·∫£')) || (keyword !== '' && btnText.includes(keyCheck))) {
                 b.classList.remove('text-gray-400');
                 b.classList.add('text-white', 'bg-gray-700');
            }
        });

        renderLessons();
    };

    // --- [M·ªöI] MOBILE SUB FILTER LOGIC ---
    window.applyMobileSubFilter = (keyword, btn) => {
        // 1. Visual Active State
        const parent = document.getElementById('mobileFilterBar');
        parent.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 2. Reuse Filter Logic
        filterSubCategory('product', keyword);
    }

    // --- MOBILE HELPER ---
    window.mobileFilter = (cat, btnElement) => {
        currentSubFilter = null; // Reset sub-filter
        
        document.querySelectorAll('.nav-mobile-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        // [M·ªöI] TOGGLE SUB-FILTER BAR
        const filterBar = document.getElementById('mobileFilterBar');
        if (cat === 'product') {
            filterBar.classList.remove('hidden');
            filterBar.classList.add('flex');
            // Reset to All
            filterBar.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
            filterBar.querySelector('button:first-child').classList.add('active');
        } else {
            filterBar.classList.add('hidden');
            filterBar.classList.remove('flex');
        }

        if(cat === 'results') { loadUserResults(); currentCategory = 'results'; }
        else { ['resultView','detailView'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('heroSection').classList.remove('hidden'); document.getElementById('listView').classList.remove('hidden'); currentCategory = cat; renderLessons(); }
    }

    // --- LOAD DATA (UPDATED: CLIENT-SIDE SORT) ---
    async function loadLessons() {
        try {
            const userDoc = await getDoc(doc(db, "users", currentUser.uid));
            const userData = userDoc.data();
            const userRole = userData.role || 'learner';
            checkLoginBonus(userData); 
            updateUserStatsUI(userData);

            // 1. Fetch ALL lessons
            const snap = await getDocs(collection(db, "lessons"));
            let rawLessons = snap.docs.map(d => ({id: d.id, ...d.data()}));

            // 2. Client-side Sort
            rawLessons.sort((a, b) => {
                const orderA = (a.displayOrder !== undefined && a.displayOrder !== null) ? Number(a.displayOrder) : 9999;
                const orderB = (b.displayOrder !== undefined && b.displayOrder !== null) ? Number(b.displayOrder) : 9999;
                return orderA - orderB;
            });

            // 3. Filter by Role
            allLessons = rawLessons.filter(lesson => {
                const allowedRoles = lesson.targetRoles || ['learner']; 
                if (userRole === 'director') return true;
                if (userRole === 'sale') return allowedRoles.includes('sale') || allowedRoles.includes('learner');
                return allowedRoles.includes('learner');
            });
            
            renderLessons();
            if(allLessons.length) { 
                featuredLessons = allLessons.slice(0, 5); 
                initHeroCarousel(); 
            }
        } catch (e) {
            console.error("L·ªói t·∫£i b√†i h·ªçc:", e);
        }
    }

    // --- PROFILE & AVATAR LOGIC ---
    window.openProfileModal = async () => {
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        const d = userDoc.data();
        document.getElementById('profileNameDisplay').textContent = d.name;
        document.getElementById('profileDvnDisplay').textContent = d.dvnCode;
        document.getElementById('profName').value = d.name || '';
        document.getElementById('profDob').value = d.dob || '';
        document.getElementById('profPhone').value = d.phone || '';
        document.getElementById('profInterest').value = d.interests || '';
        
        // Show current avatar
        const avtUrl = d.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(d.name)}&background=random`;
        document.getElementById('profileAvatarPreview').src = avtUrl;
        
        document.getElementById('profileModal').classList.remove('hidden');
    }

    window.saveProfile = async () => {
        const updates = {
            name: document.getElementById('profName').value,
            dob: document.getElementById('profDob').value,
            phone: document.getElementById('profPhone').value,
            interests: document.getElementById('profInterest').value
        };
        await updateDoc(doc(db, "users", currentUser.uid), updates);
        
        // Update UI immediately
        document.getElementById('userName').textContent = updates.name;
        document.getElementById('profileModal').classList.add('hidden');
        showToast("ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆°!");
    }

    // CLIENT-SIDE IMAGE COMPRESSION (SAVE COST)
    window.handleImageUpload = (input) => {
        if(!input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // Resize to max 300px
                const maxSize = 300;
                let w = img.width, h = img.height;
                if(w > h) { if(w > maxSize){ h*=maxSize/w; w=maxSize; } } else { if(h > maxSize){ w*=maxSize/h; h=maxSize; } }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                // Compress to JPEG 0.7
                const base64 = canvas.toDataURL('image/jpeg', 0.7);
                
                // Save to Firestore directly
                updateDoc(doc(db, "users", currentUser.uid), { avatarUrl: base64 }).then(()=>{
                    document.getElementById('profileAvatarPreview').src = base64;
                    document.getElementById('headerAvatar').src = base64;
                    document.getElementById('headerAvatarMobile').src = base64;
                    showToast("ƒê√£ thay ƒë·ªïi ·∫£nh ƒë·∫°i di·ªán!");
                });
            }
        };
        reader.readAsDataURL(file);
    }

    // --- GAMIFICATION ---
    async function checkLoginBonus(userData) {
        const today = new Date().toISOString().slice(0,10);
        if (userData.lastLoginDate !== today) { await addPoints(5, 'ƒêƒÉng nh·∫≠p h√†ng ng√†y', 'login'); await updateDoc(doc(db, "users", currentUser.uid), { lastLoginDate: today }); }
    }
    async function addPoints(amount, reason, type, relatedId = null) {
        const userRef = doc(db, "users", currentUser.uid); const uData = (await getDoc(userRef)).data();
        if (type === 'study' || type === 'quiz') { const h = uData.completedActivities || {}; if (h[`${type}_${relatedId}`]) return; await updateDoc(userRef, { [`completedActivities.${type}_${relatedId}`]: true, points: increment(amount) }); } else { await updateDoc(userRef, { points: increment(amount) }); }
        const newPoints = (uData.points || 0) + amount; let stars = 0; if (newPoints >= 2000) stars = 5; else if (newPoints >= 1600) stars = 4; else if (newPoints >= 1200) stars = 3; else if (newPoints >= 800) stars = 2; else if (newPoints >= 500) stars = 1;
        if (stars !== uData.stars) await updateDoc(userRef, { stars: stars });
        updateUserStatsUI({ ...uData, points: newPoints, stars: stars }); showToast(`üéâ +${amount} ƒêi·ªÉm: ${reason}`);
    }
    
    // --- UPDATED TIMER LOGIC FOR LOCKING QUIZ ---
    function initStudyTimer(lessonId, targetSeconds) {
        clearInterval(studyInterval); studySeconds = 0; isUserActive = true;
        const userRef = doc(db, "users", currentUser.uid);
        getDoc(userRef).then(snap => {
            const history = snap.data().completedActivities || {};
            
            // Check if already completed
            if(history[`study_${lessonId}`]) { 
                document.getElementById('studyTimeDisplay').textContent = "ƒê√É HO√ÄN TH√ÄNH"; 
                document.getElementById('studyTimeDisplay').classList.add('text-green-600');
                document.getElementById('startQuizBtnContainer').classList.remove('hidden'); // SHOW BUTTON
                return; 
            }
            
            const timerDisplay = document.getElementById('studyTimeDisplay'); const targetDisplay = document.getElementById('studyTargetDisplay');
            targetDisplay.textContent = `${Math.floor(targetSeconds/60).toString().padStart(2,'0')}:${(targetSeconds%60).toString().padStart(2,'0')}`;
            const resetIdle = () => { isUserActive = true; clearTimeout(idleTimer); idleTimer = setTimeout(() => isUserActive = false, 30000); };
            ['mousemove', 'keydown', 'scroll', 'click'].forEach(evt => window.addEventListener(evt, resetIdle)); resetIdle();
            
            studyInterval = setInterval(() => {
                // ADDED CHECK: !document.hidden (Stop timer if tab is hidden)
                if (isUserActive && !document.hidden) { 
                    studySeconds++; 
                    const m = Math.floor(studySeconds/60).toString().padStart(2,'0'); 
                    const s = (studySeconds%60).toString().padStart(2,'0'); 
                    timerDisplay.textContent = `${m}:${s}`; 
                    timerDisplay.classList.remove('text-gray-400'); 
                    timerDisplay.classList.add('text-green-600'); 
                    
                    if (studySeconds >= targetSeconds) { 
                        clearInterval(studyInterval); 
                        timerDisplay.textContent = "ƒê√É HO√ÄN TH√ÄNH"; 
                        addPoints(10, 'Ho√†n th√†nh b√†i h·ªçc', 'study', lessonId); 
                        
                        // UNLOCK QUIZ BUTTON WHEN DONE
                        document.getElementById('startQuizBtnContainer').classList.remove('hidden');
                        showToast("B·∫°n ƒë√£ ho√†n th√†nh b√†i h·ªçc! C√≥ th·ªÉ l√†m b√†i ki·ªÉm tra.");
                    } 
                } else { timerDisplay.classList.add('text-gray-400'); }
            }, 1000);
        });
    }

    function updateUserStatsUI(userData) {
        const pts = userData.points || 0; document.getElementById('userPoints').textContent = pts; document.getElementById('userPointsMobile').textContent = pts + ' pts';
        const stars = userData.stars || 0; let starStr = ''; for(let i=0; i<5; i++) starStr += i < stars ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star text-gray-300"></i>';
        let label = stars===1?'T√≠ch c·ª±c':(stars===2?'H·ªçc kh√°':(stars===3?'ChƒÉm ch·ªâ':(stars===4?'N√≤ng c·ªët':(stars===5?'Xu·∫•t s·∫Øc':'C·ªë g·∫Øng l√™n'))));
        document.getElementById('userStars').innerHTML = `${starStr} <span class="ml-1 text-[9px] text-gray-500 font-normal">(${label})</span>`;
        // Avatar Update
        const avtUrl = userData.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name)}&background=random`;
        document.getElementById('headerAvatar').src = avtUrl; document.getElementById('headerAvatarMobile').src = avtUrl;
    }
    function showToast(msg) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = "toast show bg-gray-900 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-bounce"; t.innerHTML = `<i class="fa-solid fa-gift text-yellow-400 text-xl"></i> <span class="font-bold text-sm">${msg}</span>`; c.appendChild(t); setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, 4000); }

    function initHeroCarousel() { if(featuredLessons.length === 0) return; const c = document.getElementById('heroDots'); c.innerHTML = ''; featuredLessons.forEach((_, i) => { const d = document.createElement('div'); d.className = `w-2 h-2 rounded-full cursor-pointer transition-all duration-300 ${i===0 ? 'bg-orange-500 w-6' : 'bg-white/50 hover:bg-white'}`; d.onclick = () => { heroIndex = i; updateHeroSlide(); resetHeroInterval(); }; c.appendChild(d); }); updateHeroSlide(); resetHeroInterval(); }
    function resetHeroInterval() { clearInterval(heroInterval); heroInterval = setInterval(() => { heroIndex = (heroIndex + 1) % featuredLessons.length; updateHeroSlide(); }, 5000); }
    function updateHeroSlide() { const l = featuredLessons[heroIndex]; const img = document.getElementById('heroImage'); const t = document.getElementById('heroTitle'); const d = document.getElementById('heroDesc'); const b = document.getElementById('heroBadge'); img.style.opacity = '0'; t.style.opacity = '0'; d.style.opacity = '0'; b.style.opacity = '0'; setTimeout(() => { img.src = l.bannerUrl || l.image; t.textContent = l.title; d.textContent = l.description || ''; b.textContent = l.category; document.getElementById('heroStartBtn').onclick = () => openLesson(l); const dots = document.getElementById('heroDots').children; for(let i=0; i<dots.length; i++) dots[i].className = `w-2 h-2 rounded-full cursor-pointer transition-all duration-300 ${i===heroIndex ? 'bg-orange-500 w-6' : 'bg-white/50 hover:bg-white'}`; img.style.opacity = '0.6'; t.style.opacity = '1'; d.style.opacity = '1'; b.style.opacity = '1'; }, 300); }
    
    // --- UPDATED RENDER LESSONS FOR SUB-FILTER & BADGES ---
    function renderLessons() { 
        const k = document.getElementById('searchInput').value.toLowerCase(); 
        const list = document.getElementById('lessonList'); 
        if(currentCategory === 'results') return; 

        const filtered = allLessons.filter(l => {
            const matchesSearch = l.title.toLowerCase().includes(k);
            
            // Logic l·ªçc ch√≠nh
            let matchesCategory = false;
            if (currentCategory === 'all') matchesCategory = true;
            else if (currentCategory === 'video') matchesCategory = l.contentUrl && (l.contentUrl.includes('youtu') || l.contentUrl.includes('.mp4'));
            else matchesCategory = l.category === currentCategory;

            // Logic l·ªçc con (Sub-filter) - QUAN TR·ªåNG
            let matchesSub = true;
            if (currentSubFilter) {
                const contentToCheck = (l.title + " " + (l.description||"")).toLowerCase();
                matchesSub = contentToCheck.includes(currentSubFilter.toLowerCase());
            }

            return matchesSearch && matchesCategory && matchesSub;
        });

        document.getElementById('lessonCount').textContent = filtered.length; 
        list.innerHTML = ''; 
        filtered.forEach(l => { 
            const card = document.createElement('div'); 
            card.className = "lesson-card bg-white rounded-2xl border border-gray-100 overflow-hidden cursor-pointer flex flex-col h-full"; 
            
            // L·∫•y config hi·ªÉn th·ªã cho Badge
            const catConf = categoryConfig[l.category] || categoryConfig['default'];

            card.innerHTML = `<div class="h-40 relative group"><img src="${l.bannerUrl||l.image}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110"><div class="absolute top-3 left-3 ${catConf.color} border text-[10px] font-bold px-2.5 py-1 rounded-md shadow-sm uppercase tracking-wide backdrop-blur-sm">${catConf.label}</div></div><div class="p-4 flex-1 flex flex-col"><h3 class="font-bold text-sm mb-2 line-clamp-2 text-gray-800">${l.title}</h3><div class="mt-auto text-xs text-gray-400 pt-3 border-t flex justify-between"><span><i class="fa-regular fa-clock"></i> ${l.duration}p</span><span class="text-orange-600 font-bold">H·ªçc ngay <i class="fa-solid fa-arrow-right"></i></span></div></div>`; 
            card.onclick = () => openLesson(l); 
            list.appendChild(card); 
        }); 
    }

    // --- UPDATED OPEN LESSON (HIDE QUIZ BTN INITIALLY) ---
    async function openLesson(lesson) { 
        currentLesson = lesson; 
        ['heroSection','listView','resultView'].forEach(id => document.getElementById(id).classList.add('hidden')); 
        document.getElementById('detailView').classList.remove('hidden'); 
        window.scrollTo({top:0, behavior:'smooth'}); 
        document.getElementById('detailTitle').textContent = lesson.title; 
        document.getElementById('detailDesc').innerHTML = lesson.description ? lesson.description.replace(/\n/g, '<br>') : ''; 
        document.getElementById('detailInfo').textContent = `${lesson.category} ‚Ä¢ ${lesson.duration} ph√∫t`; 
        
        const viewer = document.getElementById('lessonViewer'); 
        const url = lesson.contentUrl; 
        if(url && url.includes('.pdf')) { viewer.innerHTML = `<iframe src="${url}" class="w-full h-[650px] border-none bg-white"></iframe>`; viewer.classList.remove('aspect-video'); } 
        else if (url) { let embed = url; if(url.includes("watch?v=")) embed = "https://www.youtube.com/embed/" + url.split("watch?v=")[1].split("&")[0]; else if(url.includes("youtu.be/")) embed = "https://www.youtube.com/embed/" + url.split("youtu.be/")[1].split("?")[0]; viewer.classList.add('aspect-video'); viewer.innerHTML = `<iframe src="${embed}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`; } 
        else { viewer.innerHTML = '<p class="text-white">Kh√¥ng c√≥ n·ªôi dung</p>'; } 
        
        document.getElementById('quizSectionContainer').classList.add('hidden'); 
        
        // HIDE QUIZ BUTTON INITIALLY
        document.getElementById('startQuizBtnContainer').classList.add('hidden'); 
        
        const targetSec = lesson.minStudyTime || 300; 
        initStudyTimer(lesson.id, targetSec); 
    }
    
    window.startQuiz = async () => { document.getElementById('startQuizBtnContainer').classList.add('hidden'); document.getElementById('quizSectionContainer').classList.remove('hidden'); document.getElementById('quizSectionContainer').scrollIntoView({behavior:'smooth'}); await initQuiz(currentLesson.id); }
    
    async function initQuiz(lid) { 
        const container = document.getElementById('quizSectionContainer'); 
        const content = document.getElementById('quizContent'); 
        const pag = document.getElementById('quizPagination'); 
        const result = document.getElementById('quizResult'); 
        const btn = document.getElementById('submitQuizBtn'); 
        userAnswers = {}; 
        currentQIdx = 0; 
        quizStartTime = new Date(); 
        clearInterval(quizTimerInterval); 
        quizTimerInterval = setInterval(updateTimer, 1000); 
        updateTimer(); 
        result.innerHTML = ''; 
        result.classList.add('hidden'); 
        btn.disabled = false; 
        btn.innerHTML = '<span>N·ªòP B√ÄI</span> <i class="fa-solid fa-paper-plane"></i>'; 
        content.innerHTML = '<p class="text-center text-gray-500 py-10"><i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang t·∫£i c√¢u h·ªèi...</p>'; 
        pag.innerHTML = ''; 
        
        const snap = await getDocs(query(collection(db, "questions"), where("lessonId", "==", lid))); 
        currentQuestions = snap.docs.map(d => ({id: d.id, ...d.data()})); 
        
        // ADDED SHUFFLE HERE
        shuffleArray(currentQuestions); 
        
        if(!currentQuestions.length) { 
            content.innerHTML = '<p class="text-center italic text-gray-400 py-10">B√†i h·ªçc n√†y ch∆∞a c√≥ c√¢u h·ªèi ki·ªÉm tra.</p>'; 
            btn.disabled = true; 
            clearInterval(quizTimerInterval); 
            document.getElementById('quizTimerDisplay').textContent = "00:00"; 
            return; 
        } 
        renderPagination(); 
        renderCurrentQuestion(); 
    }

    function updateTimer() { const diff = Math.floor((new Date() - quizStartTime) / 1000); document.getElementById('quizTimerDisplay').textContent = `${Math.floor(diff/60).toString().padStart(2,'0')}:${(diff%60).toString().padStart(2,'0')}`; }
    function renderPagination() { const pag = document.getElementById('quizPagination'); pag.innerHTML = ''; currentQuestions.forEach((q, idx) => { const btn = document.createElement('button'); btn.className = `quiz-nav-btn ${idx === currentQIdx ? 'active' : ''} ${userAnswers[q.id] !== undefined ? 'answered' : ''}`; btn.textContent = idx + 1; btn.onclick = () => { currentQIdx = idx; renderPagination(); renderCurrentQuestion(); }; pag.appendChild(btn); }); }
    function renderCurrentQuestion() { const q = currentQuestions[currentQIdx]; let ops = ''; q.options.forEach((opt, idx) => { const chk = userAnswers[q.id] === idx ? 'checked' : ''; ops += `<label class="flex items-start gap-3 p-4 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-orange-200 cursor-pointer transition bg-white shadow-sm mb-2"><input type="radio" name="currentQ" value="${idx}" ${chk} class="mt-1 w-5 h-5 text-orange-600 focus:ring-orange-500 accent-orange-600" onchange="window.selectAnswer('${q.id}', ${idx})"><span class="text-sm md:text-base text-gray-700 font-medium">${opt}</span></label>`; }); document.getElementById('quizContent').innerHTML = `<div class="animate-fade-in"><h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6 leading-relaxed"><span class="text-orange-600">C√¢u ${currentQIdx + 1}:</span> ${q.text}</h3><div class="flex flex-col">${ops}</div></div>`; }
    window.selectAnswer = (qId, idx) => { userAnswers[qId] = idx; renderPagination(); };

    document.getElementById('submitQuizBtn').onclick = async function() { if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); const ansC = Object.keys(userAnswers).length; if(ansC < currentQuestions.length && !confirm(`B·∫°n m·ªõi l√†m ${ansC}/${currentQuestions.length} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?`)) return; let correct = 0; currentQuestions.forEach(q => { if(userAnswers[q.id] === q.correctIndex) correct++; }); const totalQ = currentQuestions.length; const score100 = Math.round((correct / totalQ) * 100); const isPass = score100 === 100; const res = document.getElementById('quizResult'); res.innerHTML = `<div class="p-6 rounded-xl border-2 ${isPass ? 'bg-green-50 border-green-400 text-green-800' : 'bg-red-50 border-red-300 text-red-800'} shadow-sm"><div class="text-4xl font-bold mb-2">${score100} / 100 ƒêi·ªÉm</div><p class="font-bold text-lg mb-1">K·∫øt qu·∫£: ${correct}/${totalQ} c√¢u ƒë√∫ng</p><p class="font-medium">${isPass ? 'üéâ XU·∫§T S·∫ÆC! B·∫†N ƒê√É HO√ÄN TH√ÄNH B√ÄI THI.' : 'üòì B·∫†N C·∫¶N ƒê·∫†T 100 ƒêI·ªÇM ƒê·ªÇ HO√ÄN TH√ÄNH. VUI L√íNG TH·ª¨ L·∫†I.'}</p></div>`; res.classList.remove('hidden'); res.scrollIntoView({behavior:'smooth'}); this.disabled = true; this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...'; clearInterval(quizTimerInterval); const dur = Math.floor((new Date() - quizStartTime)/1000); try { if (isPass) { await addPoints(50, 'ƒê·∫°t 100 ƒëi·ªÉm b√†i thi', 'quiz', currentLesson.id); } await addDoc(collection(db, "exam_results"), { uid: currentUser.uid, email: currentUser.email, name: document.getElementById('userName').textContent, dvn: document.getElementById('userDvn').textContent, lessonId: currentLesson.id, lessonTitle: currentLesson.title, score: score100, total: 100, correctCount: correct, questionCount: totalQ, duration: dur, timestamp: serverTimestamp() }); this.textContent = "ƒê√£ l∆∞u k·∫øt qu·∫£"; } catch(e) { console.error(e); this.textContent = "L·ªói l∆∞u k·∫øt qu·∫£"; } };

    async function loadUserResults() { ['heroSection','listView','detailView'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('resultView').classList.remove('hidden'); const tbody = document.getElementById('myResultTable'); tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center"><i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>'; const q = query(collection(db, "exam_results"), where("uid", "==", currentUser.uid)); const snap = await getDocs(q); const results = []; snap.forEach(d => results.push(d.data())); results.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); tbody.innerHTML = ''; if(results.length === 0) { document.getElementById('emptyResult').classList.remove('hidden'); document.getElementById('sumCount').textContent = "0"; document.getElementById('sumAvg').textContent = "0.0"; document.getElementById('sumRank').textContent = "---"; } else { document.getElementById('emptyResult').classList.add('hidden'); } let totalScoreSum = 0; let passCount = 0; results.forEach(r => { const date = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleDateString('vi-VN') : '--/--'; const m = Math.floor((r.duration||0)/60); const s = (r.duration||0)%60; let finalScore = r.score; if(r.total < 100) { finalScore = Math.round((r.score / r.total) * 100); } totalScoreSum += finalScore; const isPass = finalScore === 100; if(isPass) passCount++; tbody.innerHTML += `<tr class="hover:bg-gray-50 transition border-b border-gray-50"><td class="p-4 font-medium text-gray-900">${r.lessonTitle}</td><td class="p-4 text-center font-bold text-gray-800">${finalScore}/100</td><td class="p-4 text-center text-gray-500 text-xs font-mono">${m}p ${s}s</td><td class="p-4 text-center text-gray-500 text-xs">${date}</td><td class="p-4 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${isPass ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${isPass ? 'Pass' : 'Fail'}</span></td></tr>`; }); const count = results.length; document.getElementById('sumCount').textContent = count; if(count > 0) { const avg = totalScoreSum / count; document.getElementById('sumAvg').textContent = avg.toFixed(1); let rank = 'Trung b√¨nh'; let clr = 'text-orange-600'; if(avg >= 80) { rank = 'Gi·ªèi'; clr = 'text-green-600'; } else if(avg >= 65) { rank = 'Kh√°'; clr = 'text-blue-600'; } const re = document.getElementById('sumRank'); re.textContent = rank; re.className = `p-3 text-center font-bold ${clr}`; } }

    // --- CHAT SYSTEM LOGIC ---
    window.toggleChat = () => {
        isChatOpen = !isChatOpen;
        const box = document.getElementById('chatBox');
        if (isChatOpen) {
            box.classList.add('open');
            document.getElementById('chatUnreadDot').classList.add('hidden'); // Clear unread on open
            if(currentUser) listenToChat();
        } else {
            box.classList.remove('open');
        }
    }

    function listenToChat() {
        if(!currentUser) return;
        onSnapshot(doc(db, "conversations", currentUser.uid), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                renderChatUI(data.messages);
                // Notification if closed
                if(!isChatOpen && data.isReadByStudent === false) {
                    document.getElementById('chatUnreadDot').classList.remove('hidden');
                }
            }
        });
    }

    function renderChatUI(messages) {
        const div = document.getElementById('chatMessages');
        div.innerHTML = '';
        if(!messages) return;
        messages.forEach(msg => {
            const isMe = msg.sender === 'student';
            div.innerHTML += `<div class="msg-bubble ${isMe ? 'msg-sent' : 'msg-received'}">${msg.text}</div>`;
        });
        div.scrollTop = div.scrollHeight;
    }

    window.sendChatMsg = async () => {
        const input = document.getElementById('chatInput');
        const txt = input.value.trim();
        if(!txt || !currentUser) return;
        
        input.value = '';
        const newMessage = { sender: 'student', text: txt, time: Date.now() };
        
        const chatRef = doc(db, "conversations", currentUser.uid);
        const docSnap = await getDoc(chatRef);
        
        if (docSnap.exists()) {
            await updateDoc(chatRef, {
                messages: arrayUnion(newMessage),
                lastMessage: txt,
                updatedAt: serverTimestamp(),
                isReadByAdmin: false
            });
        } else {
            await setDoc(chatRef, {
                uid: currentUser.uid,
                studentName: document.getElementById('userName').textContent,
                dvn: document.getElementById('userDvn').textContent,
                messages: [newMessage],
                lastMessage: txt,
                updatedAt: serverTimestamp(),
                isReadByAdmin: false,
                isReadByStudent: true
            });
        }
    }

    /* ƒê√É COMMENT L·∫†I ƒê·ªÇ S·ª¨A L·ªñI MENU
    document.querySelectorAll('.sidebar-item').forEach(b => { b.onclick = () => { document.querySelectorAll('.sidebar-item').forEach(x => x.classList.remove('active')); b.classList.add('active'); const cat = b.dataset.category; if(cat === 'results') { loadUserResults(); currentCategory = 'results'; } else { ['resultView','detailView'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('heroSection').classList.remove('hidden'); document.getElementById('listView').classList.remove('hidden'); currentCategory = cat; renderLessons(); } }; });
    */

    document.getElementById('backToListBtn').onclick = () => { document.getElementById('detailView').classList.add('hidden'); document.getElementById('heroSection').classList.remove('hidden'); document.getElementById('listView').classList.remove('hidden'); document.getElementById('lessonViewer').innerHTML = ''; clearInterval(quizTimerInterval); clearInterval(studyInterval); document.getElementById('studyTimerBox').classList.add('hidden'); };
    document.getElementById('searchInput').addEventListener('keyup', renderLessons);
    document.getElementById('openRegister').onclick = () => document.getElementById('registerBox').classList.toggle('hidden');
    document.getElementById('loginBtn').onclick = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } catch(e) { document.getElementById('loginError').textContent = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!"; } };
    document.getElementById('registerBtn').onclick = async () => { const e = document.getElementById('regEmail').value, p = document.getElementById('regPassword').value, n = document.getElementById('regName').value, d = document.getElementById('regDvn').value, role = document.getElementById('regRole').value; if(!e||!p||!n||!d||!role) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!"); const b = document.getElementById('registerBtn'); b.textContent="..."; b.disabled=true; try { const c = await createUserWithEmailAndPassword(auth, e, p); await setDoc(doc(db, "users", c.user.uid), { uid: c.user.uid, email: e, name: n, dvnCode: d, role: role, status: 'pending', createdAt: serverTimestamp(), points: 0, stars: 0 }); await signOut(auth); alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ch·ªù Admin duy·ªát."); document.getElementById('registerBox').classList.add('hidden'); } catch(err) { alert(err.message); } finally { b.textContent="G·ª≠i y√™u c·∫ßu"; b.disabled=false; } };
    document.getElementById('logoutBtn').onclick = () => signOut(auth);
    document.getElementById('logoutBtnDesktop').onclick = () => signOut(auth); // Added for desktop logout

    onAuthStateChanged(auth, async (u) => { 
        currentUser = u; 
        if(u) { 
            const d = await getDoc(doc(db, "users", u.uid)); 
            if(d.exists()) { 
                const data = d.data(); 
                if(data.status === 'pending') { await signOut(auth); alert("T√†i kho·∫£n ƒëang ch·ªù duy·ªát!"); return; } 
                if(data.status === 'banned') { await signOut(auth); alert("T√†i kho·∫£n ƒë√£ b·ªã KH√ìA."); return; } 
                document.getElementById('authOverlay').classList.add('hidden'); 
                document.getElementById('userName').textContent = data.name; 
                document.getElementById('userDvn').textContent = data.dvnCode; 
                document.getElementById('chatBtn').classList.remove('hidden'); // Show Chat Btn
                loadLessons(); 
                listenToChat(); // Start listening
            } else { document.getElementById('authOverlay').classList.add('hidden'); } 
        } else { 
            document.getElementById('authOverlay').classList.remove('hidden'); 
            document.getElementById('chatBtn').classList.add('hidden'); 
        } 
    });

    // --- [M·ªöI] LOGIC EMOJI CHO H·ªåC VI√äN ---
    const emojiList = ["üòÄ","üòÅ","üòÇ","ü§£","üòç","ü•∞","üòé","ü§î","üò≠","üò§","üëç","üëé","üëå","‚ù§","üß°","üíî","üéâ","üî•","‚ú®","‚úÖ","‚ùå","üëã","üôè","üèç"];
    const pickerUser = document.getElementById('emojiPickerUser');
    
    // T·∫°o c√°c n√∫t icon
    if(pickerUser) {
        emojiList.forEach(icon => {
            const btn = document.createElement('button');
            btn.className = "hover:bg-gray-100 p-1.5 rounded-lg text-lg transition flex items-center justify-center";
            btn.textContent = icon;
            btn.onclick = () => {
                const input = document.getElementById('chatInput');
                input.value += icon;
                input.focus();
                // T·ª± ƒë·ªông ƒë√≥ng b·∫£ng sau khi ch·ªçn (n·∫øu mu·ªën gi·ªØ b·∫£ng th√¨ x√≥a d√≤ng d∆∞·ªõi)
                pickerUser.classList.add('hidden'); 
            };
            pickerUser.appendChild(btn);
        });
    }
  </script>
</body>
</html>
